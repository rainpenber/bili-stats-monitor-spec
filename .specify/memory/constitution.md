<!--
Sync Impact Report
- Version change: 1.0.0 → 1.1.0
- Modified principles:
  - 无
- Added sections:
  - VI. 分层架构与职责分离（新增）
- Removed sections:
  - 无
- Templates requiring updates:
  - ✅ .specify/templates/plan-template.md（在 Constitution Check 中增加分层架构检查项）
  - ⚠️ backend/src/routes/accounts.ts（需要重构：将数据库操作移至服务层）
- Follow-up TODOs:
  - TODO(RATIFICATION_DATE): 项目最初宪章正式通过日期待确认
  - TODO(REFACTOR): 重构 accounts.ts 路由，移除直接数据库操作
-->

# Bili Stats Monitor Constitution

## Core Principles

### I. 前端优先与展示驱动

本项目在设计每一项能力时，必须**先从前端展示与交互出发**：  
- 必须先明确页面结构、核心视图（如数据大盘、图表、趋势对比等）和关键交互流程；  
- 必须在规划 API 和后端实现前，完成前端原型或页面草图，并在规格文档中记录；  
- 任何新增功能的评审必须首先评估其对用户可见界面和体验的影响。  

**Rationale**: 项目以“监控与可视化”为核心价值，前端是用户价值的直接载体，通过前端优先可以约束后续 API、后端实现的复杂度，避免为不可见的抽象过度设计。

### II. API 合约先行

在前端原型确定后，必须**先定义清晰的 API 合约**，再进行具体后端编码：  
- 必须在 `specs/` 中为每个功能补充或更新 OpenAPI/契约文档，包括请求参数、响应结构、错误码和分页/过滤等约束；  
- API 合约变更（新增字段、语义变更、删除字段）必须在 spec 中有对应的“ADDED/MODIFIED/REMOVED Requirements”，并经过评审；  
- 前端与后端开发都必须以 API 合约为唯一真源进行对齐，不允许“代码即文档”的口头约定。  

**Rationale**: 以合约为中心可以降低前后端耦合与反复沟通成本，保证监控指标、维度和过滤条件在界面与数据层之间的一致性。

### III. 后端以 Bun 运行时为基础

后端服务在本项目中**统一以 Bun 作为运行时**：  
- 新增后端服务或脚本必须在 Bun 运行时下可直接运行，不得依赖 Node.js 特有特性而破坏兼容性；  
- 构建、启动、测试相关的脚本应优先使用 Bun 提供的能力（如 `bun run`、`bun test`），除非有明确的技术限制并在文档中说明；  
- 如需引入与 Bun 兼容性存疑的依赖，必须在设计阶段说明风险与验证方式。  

**Rationale**: 统一 Bun 运行时可以利用其性能和一体化工具链，同时避免后端运行环境分裂带来的维护成本。

### IV. Monorepo 单一代码库管理

本项目必须保持 **monorepo 结构**，前端与后端在同一仓库下协同管理：  
- 包与应用管理统一采用 `pnpm` 工作空间；  
- 前端应用使用 `Vite` 作为构建与开发服务器的默认选择；  
- 后端服务在 `backend/`（或等价目录）中集中管理，前端在 `frontend/`（或等价目录）中集中管理，公共包放在 `packages/` 或同等位置；  
- 对目录结构的任何较大调整，必须在 plan 和 tasks 文档中给出迁移计划与影响范围。  

**Rationale**: Monorepo 有利于前后端共享类型、协议和工具，提高协作效率，同时使依赖管理和版本演进更可控。

### V. 渐进式交付与质量约束

本项目的交付必须遵循"小步快跑、可独立验证"的原则：  
- 每个 Feature 必须拆分为可以独立交付的用户故事，且每个故事在前端有可演示界面；  
- 必须保证前端视图、API 合约和后端实现三者在每一个增量上保持可运行和可验证状态；  
- 引入复杂度（新框架、新层次抽象）前必须在 plan 中说明原因、预期收益与替代方案。  

**Rationale**: 渐进式交付和明确的质量约束有助于提高反馈频率，降低回滚成本，尤其适合以监控与可视化为核心的产品迭代。

### VI. 分层架构与职责分离

后端代码必须遵循严格的分层架构，确保各层职责清晰：  
- **路由层（Routes）**：仅负责 HTTP 请求/响应处理、参数验证、调用服务层方法，**禁止直接操作数据库**；  
- **服务层（Services）**：负责业务逻辑、数据转换、数据库操作（通过 ORM），是路由层与数据层之间的唯一桥梁；  
- **数据层（Database/ORM）**：由服务层统一访问，路由层不得直接使用 ORM 进行查询或更新操作；  
- 任何在路由层发现直接数据库操作（如 `db.select()`, `db.insert()`, `db.update()`, `db.delete()`）的代码必须重构至服务层。  

**Rationale**: 分层架构确保业务逻辑可复用、可测试，同时降低路由层复杂度，使代码更易维护和扩展。职责分离也有助于未来引入缓存、事务管理等横切关注点。

## 技术栈与架构约束

本项目在技术栈和架构上遵循以下不可违背的约定：  
- **前端技术栈**: 统一使用 `pnpm` + `Vite`，组件与页面结构应保持可组合、可复用；  
- **后端运行时**: 统一使用 Bun 运行时，服务与脚本均需在 Bun 环境下可运行；  
- **仓库结构**: 默认采用 `frontend/`、`backend/`、`packages/` 等清晰分区的 monorepo 布局；  
- **契约存放位置**: 所有对外或前端依赖的 HTTP 接口必须有对应的 OpenAPI/契约文件，统一放置在 `specs/` 下的对应能力目录中；  
- **环境配置**: 开发、测试、生产环境的配置必须通过显式配置文件或环境变量管理，不得依赖隐式本地状态。  

任何偏离上述约定的决策，必须在 `openspec/changes/` 下通过 proposal 形式提出，并在评审通过后执行。

## 开发流程与质量门禁

为确保实现过程与本宪章一致，所有功能开发必须遵循以下流程与质量门禁：  

1. **前端视图先行**  
   - 在编写实现计划前，先在 spec/plan 中写清楚前端页面/组件结构和关键交互；  
   - 评审时优先查看原型或页面示意，而非后端模型或数据库设计。  

2. **API 合约锁定**  
   - 在前端视图稳定后，更新或新增对应的 OpenAPI/契约文件；  
   - 未通过合约评审的接口不得进入后端实现阶段。  

3. **后端实现与运行时约束**  
   - 根据已批准的合约，用 Bun 运行时实现后端逻辑；  
   - 必须保证在本地通过 Bun 的启动与测试流程可稳定运行。  

4. **增量交付与验证**  
   - 每个用户故事必须在前端具备可演示页面，在 API 层具备可调用接口，在后端具备可观测日志或指标；  
   - 每个合并请求必须说明本次变更对应的用户故事与验证方式。  

5. **代码评审要求**  
   - 评审必须显式检查是否遵守"前端→API→后端"的顺序，以及是否符合 Bun + Vite + monorepo 的栈约束；  
   - 必须检查后端代码是否遵循分层架构：路由层不得直接操作数据库，所有数据库操作必须通过服务层进行；  
   - 对引入额外复杂度的修改，评审中必须要求提供在 plan/tasks/openspec proposal 中的依据链接。  

## Governance

本宪章在本仓库中对前端、API、后端的协作方式具有最高约束力：  

- **优先级**: 当与其他文档（README、quickstart、代码注释等）存在冲突时，以本宪章为准；  
- **遵从性检查**:  
  - `/speckit.plan` 生成的实现计划必须包含“Constitution Check”小节，并根据本宪章列出通过/违反的关卡；  
  - 代码评审与任务拆分必须参考本宪章中关于前端优先、API 合约、Bun 运行时和 monorepo 结构的约束；  
- **修订流程**:  
  - 任何对核心原则或架构约束的重大修改，必须通过 OpenSpec change proposal 提出并说明影响；  
  - 经评审通过后，方可更新本文件与相关模板；  
- **版本与审计**:  
  - 本宪章的每一次修改必须更新版本号和最近修订日期；  
  - 重大版本变更（MAJOR）应在变更说明中附带迁移策略。  

**Version**: 1.1.0 | **Ratified**: TODO(RATIFICATION_DATE): 项目最初宪章正式通过日期待确认 | **Last Amended**: 2025-12-20
