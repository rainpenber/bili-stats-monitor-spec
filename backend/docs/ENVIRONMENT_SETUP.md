# ç¯å¢ƒé…ç½®æŒ‡å—
# Environment Setup Guide

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•é…ç½®å’Œä½¿ç”¨å¼€å‘ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒã€‚

## ğŸ“‹ ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [é…ç½®æ–‡ä»¶è¯´æ˜](#é…ç½®æ–‡ä»¶è¯´æ˜)
- [å¯åŠ¨å‘½ä»¤](#å¯åŠ¨å‘½ä»¤)
- [ç¯å¢ƒå˜é‡è¯¦è§£](#ç¯å¢ƒå˜é‡è¯¦è§£)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶

æˆ‘ä»¬æä¾›äº†ä¸¤ç§é…ç½®æ–¹å¼ï¼š**æ–‡ä»¶é…ç½®**ï¼ˆæ¨èï¼‰å’Œ**ç¯å¢ƒå˜é‡é…ç½®**ã€‚

#### æ–¹å¼Aï¼šæ–‡ä»¶é…ç½®ï¼ˆæ¨èï¼‰

å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„é…ç½®å·²ç»å†…ç½®åœ¨ä»£ç ä¸­ï¼š

- `backend/config/development.ts` - å¼€å‘ç¯å¢ƒé…ç½®
- `backend/config/production.ts` - ç”Ÿäº§ç¯å¢ƒé…ç½®

ç³»ç»Ÿä¼šæ ¹æ® `NODE_ENV` ç¯å¢ƒå˜é‡è‡ªåŠ¨åŠ è½½å¯¹åº”çš„é…ç½®ã€‚

#### æ–¹å¼Bï¼šç¯å¢ƒå˜é‡é…ç½®ï¼ˆå¯é€‰è¦†ç›–ï¼‰

å¦‚æœéœ€è¦è¦†ç›–é»˜è®¤é…ç½®ï¼Œå¯ä»¥åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# åœ¨ backend ç›®å½•ä¸‹

# å¼€å‘ç¯å¢ƒ
cp env-template.txt .env.development

# ç”Ÿäº§ç¯å¢ƒ  
cp env-template.txt .env.production
```

ç„¶åæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹é…ç½®å€¼ã€‚

### 2. é€‰æ‹©ç¯å¢ƒå¯åŠ¨

```bash
# å¼€å‘ç¯å¢ƒå¯åŠ¨
npm run dev
# æˆ–
npm run start:dev

# ç”Ÿäº§ç¯å¢ƒå¯åŠ¨
npm run start
# æˆ–
npm run start:prod
```

---

## ğŸ“ é…ç½®æ–‡ä»¶è¯´æ˜

### æ–‡ä»¶ç»“æ„

```
backend/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ index.ts           # é…ç½®åŠ è½½å™¨ï¼ˆè‡ªåŠ¨é€‰æ‹©ç¯å¢ƒï¼‰
â”‚   â”œâ”€â”€ development.ts     # å¼€å‘ç¯å¢ƒé…ç½®
â”‚   â””â”€â”€ production.ts      # ç”Ÿäº§ç¯å¢ƒé…ç½®
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ start-dev.ts       # å¼€å‘ç¯å¢ƒå¯åŠ¨è„šæœ¬
â”‚   â””â”€â”€ start-prod.ts      # ç”Ÿäº§ç¯å¢ƒå¯åŠ¨è„šæœ¬
â”œâ”€â”€ .env.development       # å¼€å‘ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼Œç”¨äºè¦†ç›–ï¼‰
â”œâ”€â”€ .env.production        # ç”Ÿäº§ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼Œç”¨äºè¦†ç›–ï¼‰
â””â”€â”€ env-template.txt       # ç¯å¢ƒå˜é‡æ¨¡æ¿
```

### é…ç½®ä¼˜å…ˆçº§

å¯¹äºæ¯ä¸ªé…ç½®é¡¹ï¼Œä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š

1. **ç¯å¢ƒå˜é‡** - ä» `.env.{environment}` æ–‡ä»¶è¯»å–
2. **ä»£ç é…ç½®** - ä» `config/{environment}.ts` è¯»å–
3. **é»˜è®¤å€¼** - ä»£ç ä¸­å®šä¹‰çš„é»˜è®¤å€¼

---

## ğŸ® å¯åŠ¨å‘½ä»¤

### å¼€å‘ç¯å¢ƒ

```bash
# æ–¹å¼1: ä½¿ç”¨ npm run dev
npm run dev

# æ–¹å¼2: ä½¿ç”¨ npm run start:dev
npm run start:dev

# æ–¹å¼3: ç›´æ¥è¿è¡Œè„šæœ¬
bun run scripts/start-dev.ts
```

**ç‰¹ç‚¹**ï¼š
- âœ… çƒ­é‡è½½
- âœ… è¯¦ç»†é”™è¯¯ä¿¡æ¯
- âœ… APIè¯·æ±‚æ—¥å¿—
- âœ… æ€§èƒ½ç›‘æ§
- âš¡ 1åˆ†é’Ÿæœ€å°é‡‡é›†é—´éš”
- ğŸ—„ï¸ æ•°æ®å­˜å‚¨åœ¨ `./data/dev/`

### ç”Ÿäº§ç¯å¢ƒ

```bash
# æ–¹å¼1: ä½¿ç”¨ npm run start
npm run start

# æ–¹å¼2: ä½¿ç”¨ npm run start:prod
npm run start:prod

# æ–¹å¼3: ç›´æ¥è¿è¡Œè„šæœ¬
bun run scripts/start-prod.ts
```

**ç‰¹ç‚¹**ï¼š
- ğŸ”’ å®‰å…¨å¢å¼ºï¼ˆå¿…é¡»è®¾ç½®å¼ºJWTå¯†é’¥ï¼‰
- âš¡ æ€§èƒ½ä¼˜åŒ–ï¼ˆæ›´å¤§çš„ç¼“å­˜ã€æ›´ä¿å®ˆçš„è¯·æ±‚é—´éš”ï¼‰
- ğŸ“Š ç²¾ç®€æ—¥å¿—ï¼ˆåªè®°å½•infoåŠä»¥ä¸Šçº§åˆ«ï¼‰
- â±ï¸ 5åˆ†é’Ÿæœ€å°é‡‡é›†é—´éš”
- ğŸ—„ï¸ æ•°æ®å­˜å‚¨åœ¨ `./data/prod/`

---

## ğŸ”§ ç¯å¢ƒå˜é‡è¯¦è§£

### å¿…éœ€é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

#### JWT_SECRET
- **ç±»å‹**: string
- **å¿…éœ€**: æ˜¯ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- **è¯´æ˜**: JWTåŠ å¯†å¯†é’¥ï¼Œç”¨äºç”¨æˆ·è®¤è¯
- **è¦æ±‚**: ç”Ÿäº§ç¯å¢ƒè‡³å°‘32å­—ç¬¦
- **ç”Ÿæˆæ–¹æ³•**:
  ```bash
  # ä½¿ç”¨ openssl ç”Ÿæˆéšæœºå¯†é’¥
  openssl rand -base64 48
  
  # æˆ–ä½¿ç”¨ Node.js
  node -e "console.log(require('crypto').randomBytes(48).toString('base64'))"
  ```

### åº”ç”¨é…ç½®

#### NODE_ENV
- **ç±»å‹**: `development` | `production`
- **é»˜è®¤å€¼**: `development`
- **è¯´æ˜**: è¿è¡Œç¯å¢ƒ
- **è‡ªåŠ¨è®¾ç½®**: ç”±å¯åŠ¨è„šæœ¬è‡ªåŠ¨è®¾ç½®ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®

#### PORT
- **ç±»å‹**: number
- **é»˜è®¤å€¼**: `3000`
- **è¯´æ˜**: åº”ç”¨ç›‘å¬ç«¯å£

### æ•°æ®åº“é…ç½®

#### DATABASE_URL
- **ç±»å‹**: string
- **å¼€å‘ç¯å¢ƒé»˜è®¤**: `./data/dev/bili-stats-dev.db`
- **ç”Ÿäº§ç¯å¢ƒé»˜è®¤**: `./data/prod/bili-stats.db`
- **è¯´æ˜**: SQLiteæ•°æ®åº“æ–‡ä»¶è·¯å¾„

### Bilibili APIé…ç½®

#### BILI_REQUEST_INTERVAL
- **ç±»å‹**: numberï¼ˆæ¯«ç§’ï¼‰
- **å¼€å‘ç¯å¢ƒé»˜è®¤**: `1000`
- **ç”Ÿäº§ç¯å¢ƒé»˜è®¤**: `2000`
- **è¯´æ˜**: APIè¯·æ±‚é—´éš”ï¼Œé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹

#### BILI_REQUEST_TIMEOUT
- **ç±»å‹**: numberï¼ˆæ¯«ç§’ï¼‰
- **å¼€å‘ç¯å¢ƒé»˜è®¤**: `10000`
- **ç”Ÿäº§ç¯å¢ƒé»˜è®¤**: `15000`
- **è¯´æ˜**: APIè¯·æ±‚è¶…æ—¶æ—¶é—´

### æ—¥å¿—é…ç½®

#### LOG_LEVEL
- **ç±»å‹**: `debug` | `info` | `warn` | `error`
- **å¼€å‘ç¯å¢ƒé»˜è®¤**: `debug`
- **ç”Ÿäº§ç¯å¢ƒé»˜è®¤**: `info`
- **è¯´æ˜**: æ—¥å¿—çº§åˆ«

#### LOG_RETENTION_DAYS
- **ç±»å‹**: number
- **å¼€å‘ç¯å¢ƒé»˜è®¤**: `7`
- **ç”Ÿäº§ç¯å¢ƒé»˜è®¤**: `30`
- **è¯´æ˜**: æ—¥å¿—æ–‡ä»¶ä¿ç•™å¤©æ•°

### CORSé…ç½®

#### CORS_ORIGIN
- **ç±»å‹**: stringï¼ˆé€—å·åˆ†éš”çš„URLåˆ—è¡¨ï¼‰
- **å¼€å‘ç¯å¢ƒé»˜è®¤**: `http://localhost:5173,http://localhost:5174,http://127.0.0.1:5173`
- **ç”Ÿäº§ç¯å¢ƒé»˜è®¤**: `https://yourdomain.com`
- **è¯´æ˜**: å…è®¸çš„å‰ç«¯åŸŸå
- **ç¤ºä¾‹**: `https://example.com,https://www.example.com`

### ä»»åŠ¡è°ƒåº¦é…ç½®

#### MIN_COLLECTION_INTERVAL
- **ç±»å‹**: numberï¼ˆåˆ†é’Ÿï¼‰
- **å¼€å‘ç¯å¢ƒé»˜è®¤**: `1`
- **ç”Ÿäº§ç¯å¢ƒé»˜è®¤**: `5`
- **è¯´æ˜**: æœ€å°æ•°æ®é‡‡é›†é—´éš”

#### MAX_CONCURRENT_TASKS
- **ç±»å‹**: number
- **å¼€å‘ç¯å¢ƒé»˜è®¤**: `5`
- **ç”Ÿäº§ç¯å¢ƒé»˜è®¤**: `10`
- **è¯´æ˜**: æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°

### æ€§èƒ½é…ç½®

#### ENABLE_QUERY_CACHE
- **ç±»å‹**: boolean
- **é»˜è®¤å€¼**: `true`
- **è¯´æ˜**: æ˜¯å¦å¯ç”¨æŸ¥è¯¢ç¼“å­˜

#### CACHE_TTL
- **ç±»å‹**: numberï¼ˆç§’ï¼‰
- **å¼€å‘ç¯å¢ƒé»˜è®¤**: `300`
- **ç”Ÿäº§ç¯å¢ƒé»˜è®¤**: `600`
- **è¯´æ˜**: ç¼“å­˜è¿‡æœŸæ—¶é—´

### è°ƒè¯•é…ç½®

#### ENABLE_DETAILED_ERRORS
- **ç±»å‹**: boolean
- **å¼€å‘ç¯å¢ƒé»˜è®¤**: `true`
- **ç”Ÿäº§ç¯å¢ƒé»˜è®¤**: `false`
- **è¯´æ˜**: æ˜¯å¦åœ¨APIå“åº”ä¸­è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯
- **å®‰å…¨æç¤º**: ç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­ï¼Œé¿å…æ³„éœ²æ•æ„Ÿä¿¡æ¯

#### ENABLE_API_LOGGING
- **ç±»å‹**: boolean
- **å¼€å‘ç¯å¢ƒé»˜è®¤**: `true`
- **ç”Ÿäº§ç¯å¢ƒé»˜è®¤**: `false`
- **è¯´æ˜**: æ˜¯å¦è®°å½•APIè¯·æ±‚æ—¥å¿—
- **æ€§èƒ½æç¤º**: ç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­ï¼Œå‡å°‘I/Oå¼€é”€

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å®‰å…¨æ€§

#### ç”Ÿäº§ç¯å¢ƒå¿…é¡»åšçš„äº‹ï¼š

âœ… **è®¾ç½®å¼ºJWTå¯†é’¥**
```bash
# ç”Ÿæˆå¹¶è®¾ç½®åœ¨ .env.production æˆ–ç¯å¢ƒå˜é‡ä¸­
JWT_SECRET=$(openssl rand -base64 48)
```

âœ… **é…ç½®æ­£ç¡®çš„CORSåŸŸå**
```bash
# åªå…è®¸ä½ çš„å®é™…åŸŸå
CORS_ORIGIN=https://yourdomain.com,https://www.yourdomain.com
```

âœ… **å…³é—­è¯¦ç»†é”™è¯¯ä¿¡æ¯**
```bash
ENABLE_DETAILED_ERRORS=false
```

âœ… **ä½¿ç”¨HTTPS**
- ç¡®ä¿ç”Ÿäº§ç¯å¢ƒå‰ç«¯ä½¿ç”¨HTTPS
- è€ƒè™‘ä½¿ç”¨åå‘ä»£ç†ï¼ˆå¦‚Nginxï¼‰å¤„ç†SSL

âŒ **ä¸è¦åšçš„äº‹ï¼š**
- ä¸è¦å°† `.env.production` æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
- ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨é»˜è®¤JWTå¯†é’¥
- ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒå…è®¸ `localhost` çš„CORSè¯·æ±‚

### 2. æ€§èƒ½ä¼˜åŒ–

#### ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®ï¼š

```bash
# æ›´å¤§çš„ç¼“å­˜æ—¶é—´
CACHE_TTL=600

# æ›´ä¿å®ˆçš„APIè¯·æ±‚é—´éš”
BILI_REQUEST_INTERVAL=2000

# æ›´å¤šå¹¶å‘ä»»åŠ¡
MAX_CONCURRENT_TASKS=10

# æ›´é•¿çš„æ—¥å¿—ä¿ç•™
LOG_RETENTION_DAYS=30
```

### 3. å¼€å‘ä½“éªŒ

#### å¼€å‘ç¯å¢ƒæ¨èé…ç½®ï¼š

```bash
# å¿«é€Ÿåé¦ˆ
LOG_LEVEL=debug
ENABLE_DETAILED_ERRORS=true
ENABLE_API_LOGGING=true

# æ›´çŸ­çš„é—´éš”ç”¨äºæµ‹è¯•
MIN_COLLECTION_INTERVAL=1
BILI_REQUEST_INTERVAL=1000

# ä¾¿äºè°ƒè¯•
ENABLE_PERFORMANCE_MONITORING=true
```

### 4. æ•°æ®éš”ç¦»

å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸åŒçš„æ•°æ®ç›®å½•ï¼š

```
backend/data/
â”œâ”€â”€ dev/                    # å¼€å‘ç¯å¢ƒæ•°æ®
â”‚   â”œâ”€â”€ bili-stats-dev.db
â”‚   â”œâ”€â”€ media/
â”‚   â”œâ”€â”€ logs/
â”‚   â””â”€â”€ notifications.json
â””â”€â”€ prod/                   # ç”Ÿäº§ç¯å¢ƒæ•°æ®
    â”œâ”€â”€ bili-stats.db
    â”œâ”€â”€ media/
    â”œâ”€â”€ logs/
    â””â”€â”€ notifications.json
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•åˆ‡æ¢ç¯å¢ƒï¼Ÿ

**A**: ä½¿ç”¨ä¸åŒçš„å¯åŠ¨å‘½ä»¤å³å¯ï¼š
```bash
# å¼€å‘ç¯å¢ƒ
npm run dev

# ç”Ÿäº§ç¯å¢ƒ
npm run start
```

### Q2: å¦‚ä½•æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„é…ç½®ï¼Ÿ

**A**: å¯åŠ¨æ—¶ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºå½“å‰ç¯å¢ƒå’Œé…ç½®ä¿¡æ¯ï¼š
```
[Config] Loading development configuration...
[Config] Configuration validated successfully
```

### Q3: ç¯å¢ƒå˜é‡æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. ç¡®è®¤ä½¿ç”¨äº†æ­£ç¡®çš„å¯åŠ¨å‘½ä»¤
2. ç¡®è®¤ `.env.{environment}` æ–‡ä»¶åœ¨æ­£ç¡®çš„ä½ç½®ï¼ˆbackendç›®å½•ä¸‹ï¼‰
3. ç¡®è®¤ç¯å¢ƒå˜é‡åç§°æ­£ç¡®
4. é‡å¯åº”ç”¨ä»¥åŠ è½½æ–°çš„ç¯å¢ƒå˜é‡

### Q4: ç”Ÿäº§ç¯å¢ƒæç¤º"JWT_SECRET must be set"ï¼Ÿ

**A**: éœ€è¦è®¾ç½®JWTå¯†é’¥ï¼š
```bash
# æ–¹å¼1: åœ¨ .env.production ä¸­è®¾ç½®
echo "JWT_SECRET=$(openssl rand -base64 48)" > .env.production

# æ–¹å¼2: åœ¨ç”Ÿäº§ç¯å¢ƒçš„ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­è®¾ç½®
export JWT_SECRET=$(openssl rand -base64 48)
```

### Q5: å¦‚ä½•åŒæ—¶è¿è¡Œå¼€å‘å’Œç”Ÿäº§ç¯å¢ƒï¼Ÿ

**A**: å¯ä»¥é€šè¿‡ä¿®æ”¹ç«¯å£å·å®ç°ï¼š
```bash
# Terminal 1: å¼€å‘ç¯å¢ƒï¼ˆç«¯å£3000ï¼‰
npm run dev

# Terminal 2: ç”Ÿäº§ç¯å¢ƒï¼ˆç«¯å£3001ï¼‰
PORT=3001 npm run start
```

### Q6: Dockeréƒ¨ç½²å¦‚ä½•è®¾ç½®ç¯å¢ƒï¼Ÿ

**A**: åœ¨docker-compose.ymlä¸­è®¾ç½®ç¯å¢ƒå˜é‡ï¼š
```yaml
services:
  backend:
    environment:
      - NODE_ENV=production
      - PORT=3000
      - JWT_SECRET=${JWT_SECRET}
      - DATABASE_URL=/data/bili-stats.db
      # ... å…¶ä»–é…ç½®
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [éƒ¨ç½²æŒ‡å—](./DEPLOYMENT.md)
- [APIæ–‡æ¡£](../../specs/001-bilibili-monitor/api/openapi.yaml)
- [æ•°æ®åº“æ¶æ„](../src/db/schema.ts)
- [é…ç½®ç±»å‹å®šä¹‰](../config/index.ts)

---

## ğŸ†˜ è·å–å¸®åŠ©

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„[å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)éƒ¨åˆ†
2. æ£€æŸ¥åº”ç”¨æ—¥å¿—æ–‡ä»¶
3. æäº¤Issueåˆ°é¡¹ç›®ä»“åº“

---

**æœ€åæ›´æ–°**: 2025-12-25  
**ç»´æŠ¤è€…**: Bili Stats Monitor Team

