# Feature Specification: B站数据监控工具 - 核心功能

**Feature Branch**: `001-bilibili-monitor`  
**Created**: 2025-11-26  
**Status**: Draft  
**Input**: 面向视频博主的B站数据监控Web工具，支持视频和粉丝数据监控

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 管理员登录并绑定B站账号 (Priority: P1)

管理员用户通过系统登录，并将其拥有的B站账号（通过Cookie鉴权）绑定到系统中，以便后续获取该账号的私密数据（如播放完成率、平均观看时长等）。

**Why this priority**: 这是整个系统的基础。没有账号绑定，系统无法获取任何数据。管理员需要首先完成这一步才能使用系统。

**Independent Test**: 可以独立测试管理员登录流程和账号绑定流程。测试完成后，系统应该能够存储并使用该账号的Cookie进行后续数据查询。

**Acceptance Scenarios**:

1. **Given** 管理员未登录, **When** 访问系统首页, **Then** 重定向到登录页面
2. **Given** 管理员在登录页面, **When** 输入正确的用户名和密码并点击登录, **Then** 成功登录并进入仪表板
3. **Given** 管理员已登录, **When** 进入账号管理页面并输入B站Cookie（包含SESSDATA字段）, **Then** 系统验证Cookie有效性并保存
4. **Given** 管理员输入无效的Cookie, **When** 点击验证, **Then** 显示错误提示并拒绝保存
5. **Given** 管理员已绑定账号, **When** 查看账号列表, **Then** 显示已绑定的B站账号及其基本信息

---

### User Story 2 - 管理员添加监控任务 (Priority: P1)

管理员可以添加要监控的视频、博主或动态，系统会自动为这些任务设置定时数据抓取。

**Why this priority**: 这是系统的核心功能。用户需要能够指定要监控的内容，系统才能开始收集数据。

**Independent Test**: 可以独立测试任务添加流程。添加任务后，系统应该能够识别任务类型、关联的账号、定时策略，并将其加入到数据抓取队列中。

**Acceptance Scenarios**:

1. **Given** 管理员已登录, **When** 点击"添加监控任务"按钮, **Then** 弹出任务添加表单
2. **Given** 任务添加表单已打开, **When** 选择任务类型为"视频"并输入视频BV号, **Then** 系统验证BV号有效性
3. **Given** 任务信息已填写完整, **When** 选择定时策略为"智能频率"并设置监控截止时间为3个月后, **Then** 系统保存任务并显示成功提示
4. **Given** 任务已创建, **When** 查看任务列表, **Then** 新任务出现在列表中，状态为"监控中"
5. **Given** 任务已创建, **When** 后台定时任务触发, **Then** 系统按照定时策略自动抓取该任务的数据

---

### User Story 3 - 普通用户查看仪表板和数据 (Priority: P1)

普通用户可以查看所有已监控的视频、博主和动态的实时数据，但无法修改任务或系统配置。

**Why this priority**: 这是系统的主要价值体现。用户需要能够方便地查看和分析监控数据。

**Independent Test**: 可以独立测试数据展示流程。普通用户应该能够看到所有已监控内容的数据，但无法进行修改操作。

**Acceptance Scenarios**:

1. **Given** 普通用户已登录, **When** 进入仪表板, **Then** 显示所有已监控任务的概览卡片
2. **Given** 仪表板已加载, **When** 查看视频卡片, **Then** 显示视频标题、当前播放量（以"xx万"格式）、实时观看人数、弹幕数、评论数、投币数、点赞数
3. **Given** 仪表板已加载, **When** 查看博主卡片, **Then** 显示博主名称、当前粉丝数、粉丝增长趋势
4. **Given** 普通用户点击视频卡片, **When** 进入视频详情页, **Then** 显示两个EChart图表：播放量+在线观看人数折线图、互动数据（弹幕、评论、投币、点赞）折线图
5. **Given** 普通用户点击博主卡片, **When** 进入博主详情页, **Then** 显示粉丝数变化折线图，图表自动缩放到近3个月，纵轴范围为当前粉丝数±500
6. **Given** 普通用户尝试编辑任务, **When** 点击任务卡片上的编辑按钮, **Then** 显示权限不足的提示，不允许修改

---

### User Story 4 - 管理员编辑和删除监控任务 (Priority: P2)

管理员可以修改现有的监控任务（如更改定时策略、截止时间等）或删除不需要的任务。

**Why this priority**: 这是任务管理的重要功能。管理员需要能够灵活调整监控策略。

**Independent Test**: 可以独立测试任务编辑和删除流程。编辑后，系统应该按照新的策略执行任务；删除后，任务应该停止执行。

**Acceptance Scenarios**:

1. **Given** 管理员已登录, **When** 点击任务卡片上的编辑按钮, **Then** 弹出任务编辑表单，显示当前任务配置
2. **Given** 任务编辑表单已打开, **When** 修改定时策略为"固定频率"并设置间隔为1小时, **Then** 系统保存新配置
3. **Given** 任务已编辑, **When** 查看任务列表, **Then** 任务配置已更新，后续数据抓取按新策略执行
4. **Given** 管理员已登录, **When** 点击任务卡片上的删除按钮, **Then** 显示确认对话框
5. **Given** 删除确认对话框已显示, **When** 点击确认, **Then** 任务被删除，系统停止对该任务的数据抓取

---

### User Story 5 - 用户按分类和标签查看任务 (Priority: P2)

用户可以按博主、内容类型（视频/动态）或自定义标签对监控任务进行分类展示，支持多标签筛选。

**Why this priority**: 当监控任务数量增加时，分类和筛选功能帮助用户快速找到感兴趣的内容。

**Independent Test**: 可以独立测试分类筛选流程。选择不同的分类条件后，任务列表应该相应更新。

**Acceptance Scenarios**:

1. **Given** 用户已登录且有多个监控任务, **When** 进入任务列表页面, **Then** 显示分类筛选面板（按博主、内容类型、标签）
2. **Given** 分类筛选面板已显示, **When** 选择特定博主, **Then** 任务列表只显示该博主的任务
3. **Given** 分类筛选面板已显示, **When** 选择内容类型为"视频", **Then** 任务列表只显示视频监控任务
4. **Given** 分类筛选面板已显示, **When** 选择多个自定义标签, **Then** 任务列表显示包含任意一个所选标签的任务
5. **Given** 用户已应用筛选条件, **When** 点击"清除筛选", **Then** 任务列表恢复显示所有任务

---

### User Story 6 - 用户搜索监控任务 (Priority: P2)

用户可以通过关键字搜索监控任务，支持按视频BV号、博主UID、动态UID、标题、博主名等搜索。

**Why this priority**: 搜索功能提高了用户查找特定任务的效率。

**Independent Test**: 可以独立测试搜索流程。输入关键字后，系统应该返回匹配的任务。

**Acceptance Scenarios**:

1. **Given** 用户已登录, **When** 在搜索框输入视频BV号, **Then** 系统返回匹配的视频监控任务
2. **Given** 用户已登录, **When** 在搜索框输入博主名称, **Then** 系统返回该博主相关的所有监控任务
3. **Given** 用户已登录, **When** 在搜索框输入视频标题关键字, **Then** 系统返回标题包含该关键字的任务
4. **Given** 搜索结果已显示, **When** 清空搜索框, **Then** 任务列表恢复显示所有任务

---

### User Story 7 - 系统自动检测账号过期并发送告警 (Priority: P2)

当B站账号鉴权失效（连续5次查询失败），系统自动停止相关监控任务并发送告警通知。

**Why this priority**: 这是系统稳定性的重要保障。用户需要及时了解账号状态异常。

**Independent Test**: 可以独立测试账号过期检测和通知流程。模拟鉴权失败场景，系统应该正确识别并发送通知。

**Acceptance Scenarios**:

1. **Given** 系统正在执行数据抓取任务, **When** 连续5次因鉴权失败而无法获取数据, **Then** 系统识别账号过期
2. **Given** 账号过期已识别, **When** 系统停止该账号相关的所有监控任务, **Then** 任务状态变为"已停止"
3. **Given** 账号过期已识别, **When** 系统发送告警通知, **Then** 管理员收到通知（邮件/钉钉/企业微信等）
4. **Given** 账号已过期, **When** 管理员重新绑定新的Cookie, **Then** 系统验证新Cookie有效性并恢复监控任务

---

### User Story 8 - 系统记录详细的操作日志 (Priority: P3)

系统按日期保存详细的操作日志，支持三个等级（DEBUG、INFO、WARNING），用户可以查看和下载日志。

**Why this priority**: 日志对于系统调试和问题排查至关重要。

**Independent Test**: 可以独立测试日志记录和查看流程。执行各种操作后，系统应该正确记录日志。

**Acceptance Scenarios**:

1. **Given** 系统正在运行, **When** 执行数据抓取、任务启停、推送等操作, **Then** 系统按等级记录详细日志
2. **Given** 日志已记录, **When** 管理员进入日志查看页面, **Then** 显示按日期分组的日志文件列表
3. **Given** 日志列表已显示, **When** 选择特定日期的日志文件, **Then** 显示该日期的所有日志条目，支持按等级筛选
4. **Given** 日志已显示, **When** 点击下载按钮, **Then** 系统下载对应日期的日志文件

---

### User Story 9 - 系统发送多渠道告警通知 (Priority: P3)

系统支持通过邮件、钉钉、企业微信、Webhook、Bark、PushDeer、OneBot QQ机器人、Telegram等多种渠道发送告警通知。

**Why this priority**: 多渠道通知确保用户不会错过重要的系统告警。

**Independent Test**: 可以独立测试各个通知渠道的发送流程。配置不同渠道后，系统应该能够正确发送通知。

**Acceptance Scenarios**:

1. **Given** 管理员已登录, **When** 进入通知设置页面, **Then** 显示所有可用的通知渠道
2. **Given** 通知设置页面已显示, **When** 配置邮件地址并启用邮件通知, **Then** 系统保存配置
3. **Given** 通知渠道已配置, **When** 系统触发告警事件, **Then** 系统通过配置的渠道发送通知
4. **Given** 通知已发送, **When** 用户收到通知, **Then** 通知包含清晰的事件描述和建议的处理方式

---

### User Story 10 - 管理员设置粉丝变化告警阈值 (Priority: P3)

管理员可以为每个博主分别设置粉丝突增/突降的告警阈值，并选择是否启用推送通知。

**Why this priority**: 这是一个增强功能，帮助用户及时发现粉丝数据的异常变化。

**Independent Test**: 可以独立测试告警阈值配置和触发流程。设置阈值后，当粉丝数变化超过阈值时，系统应该正确触发告警。

**Acceptance Scenarios**:

1. **Given** 管理员已登录, **When** 进入博主详情页, **Then** 显示粉丝告警设置选项
2. **Given** 粉丝告警设置已打开, **When** 设置粉丝增加告警阈值为1000且启用推送, **Then** 系统保存配置
3. **Given** 告警阈值已设置, **When** 粉丝数在一天内增加超过1000, **Then** 系统触发告警并发送通知
4. **Given** 告警阈值已设置, **When** 管理员禁用该博主的推送通知, **Then** 系统不再发送该博主的告警通知

---

### Edge Cases

- **账号Cookie过期**: 系统应该在连续5次查询失败后识别并停止任务，而不是无限重试
- **监控任务超过3个月**: 系统应该自动停止超过3个月的监控任务，并记录日志
- **数据抓取队列堆积**: 当数据抓取任务堆积时，系统应该按优先级处理，确保不会同时查询多个数据
- **用户删除账号**: 删除账号时，系统应该停止该账号相关的所有监控任务
- **网络连接中断**: 数据抓取失败时，系统应该记录失败原因并在下一个周期重试
- **数据库存储满**: 由于数据永久保留，系统应该监控存储空间使用情况

---

## Requirements *(mandatory)*

### Functional Requirements

#### 账号与权限管理

- **FR-001**: 系统MUST支持两种用户角色：管理员和普通用户
- **FR-002**: 管理员MUST能够通过用户名和密码登录系统
- **FR-003**: 普通用户MUST能够通过相同的登录方式访问系统
- **FR-004**: 系统MUST允许管理员绑定B站账号（通过Cookie中的SESSDATA字段）
- **FR-005**: 系统MUST验证绑定的Cookie有效性，无效时拒绝保存并显示错误提示
- **FR-006**: 系统MUST在连续5次查询失败时识别账号过期，停止相关监控任务，并发送告警通知
- **FR-007**: 系统MUST支持管理员重新绑定新的Cookie以恢复监控任务
- **FR-008**: 普通用户MUST无法修改任务配置或系统设置

#### 监控任务管理

- **FR-009**: 系统MUST支持添加三种监控任务类型：视频、博主、动态
- **FR-010**: 系统MUST为每个监控任务关联一个B站账号（用于鉴权）
- **FR-011**: 系统MUST支持两种定时策略：
  - 固定频率：用户指定固定的查询间隔（如每小时、每天等）
  - 智能频率：前5天每10分钟查询一次，5~14天每2小时查询一次，14天后每4小时查询一次
- **FR-012**: 系统MUST为每个监控任务设置3个月的默认截止时间，超过截止时间后自动停止监控
- **FR-013**: 系统MUST允许管理员修改监控任务的定时策略和截止时间
- **FR-014**: 系统MUST允许管理员删除监控任务
- **FR-015**: 系统MUST支持任务状态管理：监控中、已停止、已完成
- **FR-016**: 系统MUST允许管理员手动启动或停止任务
- **FR-017**: 系统MUST使用队列机制处理数据抓取，确保同一时间不会同时查询多个数据源

#### 数据收集与存储

- **FR-018**: 系统MUST收集以下视频数据：播放量、实时观看人数、弹幕数、评论数、投币数、点赞数
- **FR-019**: 系统MUST对于用户持有账号的博主，每天收集一次播放完成率和平均观看时长
- **FR-020**: 系统MUST收集博主粉丝数数据
- **FR-021**: 系统MUST收集动态数据：评论数、转发数、点赞数
- **FR-022**: 系统MUST永久保留所有收集的数据
- **FR-023**: 系统MUST使用SQLite数据库存储数据

#### 数据展示与可视化

- **FR-024**: 系统MUST在仪表板显示所有监控任务的概览卡片
- **FR-025**: 系统MUST在视频卡片显示：视频标题、播放量（格式为"xx万"）、实时观看人数、弹幕数、评论数、投币数、点赞数
- **FR-026**: 系统MUST在博主卡片显示：博主名称、粉丝数、粉丝增长趋势
- **FR-027**: 系统MUST在动态卡片显示：发布时间、评论数、转发数、点赞数
- **FR-028**: 系统MUST提供视频详情页，显示两个EChart折线图：
  - 播放量和实时观看人数的变化趋势（从视频发布至今的全部数据）
  - 互动数据（弹幕、评论、投币、点赞）的变化趋势
- **FR-029**: 系统MUST提供博主详情页，显示粉丝数变化折线图，自动缩放到近3个月，纵轴范围为当前粉丝数±500
- **FR-030**: 系统MUST提供动态详情页，显示互动数据的变化趋势
- **FR-031**: 系统MUST使用EChart库实现所有图表

#### 分类与搜索

- **FR-032**: 系统MUST支持按博主分类展示监控任务
- **FR-033**: 系统MUST支持按内容类型（视频/动态）分类展示监控任务
- **FR-034**: 系统MUST支持自定义标签，允许用户为任务添加多个标签
- **FR-035**: 系统MUST支持按标签筛选任务，支持多标签组合筛选
- **FR-036**: 系统MUST支持按关键字搜索，支持搜索范围：视频BV号、博主UID、动态UID、视频标题、博主名
- **FR-037**: 系统MUST提供分页显示任务列表

#### 通知与告警

- **FR-038**: 系统MUST支持以下告警触发条件：
  - 粉丝数突增/突降超过设定阈值（每个博主分开设置）
  - 视频指定数据达到指定数值
  - 监控任务超过最大重试次数失败
  - B站账号身份过期
- **FR-039**: 系统MUST支持以下通知渠道：邮件、钉钉、企业微信、Webhook、Bark、PushDeer、OneBot QQ机器人、Telegram
- **FR-040**: 系统MUST允许管理员为每个告警条件配置是否启用推送通知
- **FR-041**: 系统MUST允许管理员配置通知渠道的接收地址/ID
- **FR-042**: 系统MUST在发送通知时包含清晰的事件描述和建议的处理方式

#### 日志记录

- **FR-043**: 系统MUST记录三个等级的日志：DEBUG、INFO、WARNING
- **FR-044**: DEBUG级别MUST记录详细的数据抓取过程（尝试抓取什么数据、抓取到什么内容）
- **FR-045**: INFO级别MUST记录数据抓取、任务启停、通知发送等操作的详细时间和内容
- **FR-046**: WARNING级别MUST记录异常事件：数据抓取失败、推送失败、身份过期等
- **FR-047**: 系统MUST按日期保存日志为独立的日志文件
- **FR-048**: 系统MUST永久保留所有日志
- **FR-049**: 系统MUST允许用户查看和下载日志文件

#### UI/UX

- **FR-050**: 系统MUST使用shadcn/ui组件库实现UI，保持简约风格
- **FR-051**: 系统MUST采用左侧导航栏+主内容区的布局
- **FR-052**: 系统MUST在导航栏提供以下页面链接：仪表板、视频、博主、动态、日志、设置
- **FR-053**: 系统MUST使用卡片列表展示监控任务，支持分页

### Key Entities

- **User**: 系统用户，包含用户名、密码、角色（管理员/普通用户）
- **BiliAccount**: B站账号，包含UID、Cookie（SESSDATA）、绑定时间、状态（有效/过期）
- **MonitoringTask**: 监控任务，包含任务ID、任务类型（视频/博主/动态）、目标ID（BV号/UID等）、关联账号、定时策略、截止时间、状态、创建时间、标签列表
- **VideoData**: 视频数据，包含视频ID、采集时间、播放量、实时观看人数、弹幕数、评论数、投币数、点赞数、播放完成率（可选）、平均观看时长（可选）
- **AuthorData**: 博主数据，包含博主UID、采集时间、粉丝数
- **DynamicData**: 动态数据，包含动态ID、采集时间、评论数、转发数、点赞数
- **Notification**: 通知配置，包含通知ID、通知渠道、接收地址/ID、启用状态
- **AlertRule**: 告警规则，包含规则ID、告警类型、触发条件、关联通知、启用状态
- **SystemLog**: 系统日志，包含日志ID、时间戳、日志等级、操作类型、详细内容

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理员可以在5分钟内完成系统登录和B站账号绑定
- **SC-002**: 管理员可以在2分钟内添加一个新的监控任务
- **SC-003**: 系统能够支持至少100个并发监控任务，不出现数据丢失或重复
- **SC-004**: 数据抓取队列处理效率：每个任务平均处理时间不超过30秒
- **SC-005**: 系统能够永久存储一年内的数据（预计数据量级：约100万条记录），SQLite数据库文件大小不超过500MB
- **SC-006**: 仪表板加载时间不超过3秒
- **SC-007**: 图表加载时间不超过5秒（包括近3个月的粉丝数据）
- **SC-008**: 账号过期检测准确率100%（在连续5次查询失败时正确识别）
- **SC-009**: 通知发送成功率不低于95%
- **SC-010**: 日志记录完整性100%（所有操作都被正确记录）
- **SC-011**: 用户可以在10秒内通过搜索或分类找到特定的监控任务
- **SC-012**: 系统可用性不低于99%（每月停机时间不超过7分钟）
- **SC-013**: 普通用户无法通过UI或API修改任务配置或系统设置（权限隔离完整性100%）

---

## Assumptions

1. **数据量估算**：
   - 假设平均监控10个视频、5个博主、10条动态
   - 视频数据：每个视频按智能频率采集，前5天每10分钟1条，5~14天每2小时1条，14天后每4小时1条
   - 计算：前5天 = 5 * 24 * 6 = 720条；5~14天 = 10 * 12 = 120条；14~365天 = 351 * 6 = 2106条
   - 单个视频年数据量 ≈ 2946条；10个视频 ≈ 29460条
   - 博主粉丝数：每天1条，365条/年；5个博主 = 1825条
   - 动态数据：按视频频率采集，10条动态 ≈ 29460条
   - **总计：约60745条记录/年**（实际可能更多，但在SQLite容量范围内）

2. **Cookie安全存储**：假设使用加密存储或安全的密钥管理方案

3. **B站API可用性**：假设B站公开API和非公开接口保持稳定

4. **用户网络连接**：假设用户有稳定的网络连接

5. **系统部署环境**：假设系统部署在具有稳定电源和网络的服务器上

---

## Notes

- 本规范关注功能需求，不涉及具体的技术实现细节
- 数据量估算基于保守假设，实际可能因监控任务数量、采集频率等因素而变化
- 通知渠道的具体集成方案需要在技术规划阶段详细设计
- 系统安全性（特别是Cookie存储和权限管理）需要在技术规划阶段重点关注
