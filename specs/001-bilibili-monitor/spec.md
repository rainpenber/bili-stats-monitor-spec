# Feature Specification: B站数据监控工具 - 核心功能

**Feature Branch**: `001-bilibili-monitor`  
**Created**: 2025-11-26  
**Status**: Draft  
**Input**: 面向视频博主的B站数据监控Web工具，支持视频和粉丝数据监控

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 管理员登录并绑定/扫码登录B站账号 (Priority: P1)

管理员用户通过系统登录，并将其拥有的B站账号绑定到系统中。绑定方式支持两种：
- 方式A：输入Cookie（包含SESSDATA）
- 方式B：扫码登录（弹出Modal展示B站官方登录二维码，扫码后后端保存登录凭据）

**Why this priority**: 无B站账号绑定将无法获取私密或更完整的数据。

**Independent Test**: 分别测试Cookie方式与扫码方式绑定流程；完成后可用该账号凭据调用受限接口完成一次验证查询。

**Acceptance Scenarios**:

1. **Given** 管理员未登录, **When** 访问系统首页, **Then** 重定向到登录页面
2. **Given** 管理员在登录页面, **When** 输入正确的用户名和密码并登录, **Then** 进入仪表板
3. **Given** 管理员已登录, **When** 在账号管理中选择“输入Cookie绑定”并输入包含SESSDATA的Cookie, **Then** 验证通过后保存
4. **Given** 管理员已登录, **When** 在账号管理中选择“扫码登录绑定”，系统获取登录二维码URL并展示Modal, **Then** 用户扫码后显示绑定成功并保存凭据
5. **Given** 管理员输入无效Cookie或扫码失败, **When** 提交, **Then** 显示错误提示并拒绝保存

---

### User Story 2 - 管理员通过链接/ID添加监控任务 (Priority: P1)

管理员可以添加“视频”或“博主”的监控任务。通过输入链接或ID，系统可自动拉取信息填充表单，简化创建流程。对于博主任务，还可选择是否同时监控其发布的视频。

**Why this priority**: 任务添加是核心功能，自动填充和批量添加能显著提升效率。

**Acceptance Scenarios**:

1. **Given** 管理员已登录, **When** 点击“新增任务”按钮, **Then** 弹出新增任务Modal
2. **Given** 在Modal中输入视频链接或BV号, **When** 点击“从链接/ID获取”, **Then** 表单中的“标题”和“BV号”字段被自动填充
3. **Given** 在Modal中选择“博主”并输入空间链接或UID, **When** 点击“从链接/ID获取”, **Then** 表单中的“昵称”和“UID”字段被自动填充
4. **Given** 添加博主任务时勾选“同时监控该博主发布的视频”, **When** 点击“创建”, **Then** 弹出第二个Modal，其中包含该博主的视频列表，支持多选和一键选择前5条
5. **Given** 在视频选择Modal中确认, **Then** 系统为所选视频批量创建监控任务

---

### User Story 3 - 普通用户查看仪表板与数据（卡片+内联详情）(Priority: P1)

普通用户以只读方式查看所有视频与博主的卡片列表与下方内联详情。

**Why this priority**: 主要价值在于随时查看数据趋势。

**Independent Test**: 验证普通用户无法修改任务或系统配置；可点击卡片切换下方详情区内容。

**Acceptance Scenarios**:

1. **Given** 普通用户已登录, **When** 进入仪表板, **Then** 显示卡片平铺列表（视频/博主）
2. **Given** 普通用户点击任何卡片, **When** 切换, **Then** 下方详情区展示对应图表（视频：两图；博主：粉丝图）
3. **Given** 普通用户在卡片上, **When** 尝试编辑, **Then** 显示权限不足提示

---

### User Story 4 - 管理员编辑任务与批量启停 (Priority: P2)

管理员可编辑任务（标题/昵称、BV/UID、定时策略、截止时间、关联账号、标签），删除操作仅在编辑Modal内进行。提供卡片多选（支持本页全选、跨页全选），支持批量“启用/禁用（启动/停止）”。

**Why this priority**: 提高运维效率，减少重复操作。

**Independent Test**: 验证编辑流程、删除在编辑Modal中的位置、批量选择与批量启停。

**Acceptance Scenarios**:

1. **Given** 管理员在列表, **When** 打开某任务编辑Modal, **Then** 可修改标题/昵称、BV/UID、策略/截止/关联账号/标签，并可在Modal内执行删除
2. **Given** 管理员需要批量操作, **When** 通过卡片左上角复选框多选/本页全选/全量全选, **Then** 点击工具栏“启用/禁用”对所选任务生效
3. **Given** 批量操作执行, **When** 成功, **Then** 展示结果汇总（成功/失败项数量）

---

### User Story 5 - 账号过期处理与任务恢复 (Priority: P2)

当某B站账号鉴权失败次数 > 5 次，系统暂停该账号关联的所有任务，并为这些任务打上“因鉴权失败暂停”的标记；管理员完成重新登录（Cookie或扫码）后，系统询问是否恢复这些被标记的任务。

**Why this priority**: 明确过期后的处置策略与恢复体验。

**Independent Test**: 模拟鉴权连续失败>5，查看任务统一暂停与标记；重新登录后出现“是否恢复”提示并可一键恢复。

**Acceptance Scenarios**:

1. **Given** 同一账号连续鉴权失败>5, **When** 系统检测到, **Then** 暂停该账号关联所有任务并标记原因；发送告警通知
2. **Given** 管理员完成账号重新登录, **When** 返回系统, **Then** 弹窗询问是否恢复此前被标记暂停的任务（可全选/部分选择）
3. **Given** 管理员选择恢复, **When** 确认, **Then** 被标记任务恢复为“监控中”，并清除暂停标记

---

### User Story 6 - 分类、搜索与卡片视图唯一制 (Priority: P2)

仅提供卡片视图（不提供表格视图）；支持按博主、对象类型（视频/博主）、标签筛选；支持关键词搜索（BV/UID/标题/博主名）。

**Why this priority**: 简化交互，聚焦常用视图。

**Independent Test**: 验证卡片筛选与搜索在无表格视图情况下的可用性。

**Acceptance Scenarios**:

1. **Given** 用户在仪表板/列表, **When** 使用分类筛选与搜索, **Then** 卡片列表正确过滤
2. **Given** 用户需要切换视图, **When** 查看选项, **Then** 不提供表格视图，仅保留卡片

---

### User Story 7 - 系统记录日志与通知 (Priority: P3)

按既定规则记录日志（DEBUG/INFO/WARNING）并在账号过期、批量操作结果等场景通知管理员。

**Why this priority**: 可观察性与可运维性。

**Independent Test**: 触发关键事件并检查日志/通知内容与口径。

**Acceptance Scenarios**:

1. **Given** 系统发生账号过期、批量操作等事件, **When** 记录日志, **Then** 等级口径符合规范
2. **Given** 触发告警事件, **When** 已配置渠道, **Then** 通知成功发送

---

## Requirements *(mandatory)*

### Functional Requirements

#### 账号与权限管理

- **FR-001**: 系统MUST支持两种用户角色：管理员和普通用户
- **FR-002**: 管理员MUST能够通过用户名和密码登录系统
- **FR-003**: 普通用户MUST能够通过相同的登录方式访问系统
- **FR-004**: 系统MUST允许管理员绑定B站账号（方式A：输入Cookie（含SESSDATA）；方式B：扫码登录Modal展示官方二维码，扫码后保存凭据）
- **FR-005**: 系统MUST验证绑定凭据有效性，无效时拒绝保存并显示错误提示
- **FR-006**: 当同一账号连续鉴权失败>5次时，系统MUST暂停该账号关联的所有监控任务并打上“因鉴权失败暂停”的标记，同时发送告警通知
- **FR-007**: 管理员完成账号重新登录后，系统MUST询问是否恢复此前被标记暂停的任务，并支持一键恢复
- **FR-008**: 普通用户MUST无法修改任务配置或系统设置
- **FR-009**: 系统设置中MUST提供用户管理：仅两位用户（管理员/普通），管理员可修改自己与普通用户密码，普通用户仅能修改自己的密码

#### 主题与外观

- **FR-010**: 系统MUST支持主题色预设（绿色/蓝色/紫色/橙色），选中卡片描边与主题色一致
- **FR-011**: 系统MUST支持深色模式与浅色模式，且支持“跟随系统/浅色/深色”三种切换方式（顶部快捷开关 + 设置页均可操作）
- **FR-012**: 深色模式下，图表MUST采用ECharts默认深色主题，整体文字/边框对比度MUST确保可读

#### 监控任务管理（卡片+内联详情）

- **FR-013**: 系统MUST支持两种监控任务类型：视频、博主
- **FR-014**: 系统MUST使用一个全局共享的默认B站账号进行所有需要鉴权的API请求。当未设置默认账号时，仅鉴权内容的抓取将暂停，并向用户显示提示。
- **FR-015**: 系统MUST支持两种定时策略：
  - 固定频率：采用“数字+单位（分钟/小时/天）”的组合输入，换算后不得小于1分钟；最大值受系统设置控制（默认1天）
  - 智能频率（视频）：以视频发布时间为起点，分为自然时间段：
    - 段A：[发布时刻, +5天) → 每10分钟
    - 段B：[+5天, +14天) → 每2小时
    - 段C：[+14天, 截止] → 每4小时
- **FR-016**: 系统MUST为每个监控任务设置3个月的默认截止时间，超过截止时间后自动停止监控
- **FR-017**: 系统MUST允许管理员修改任务的标题/昵称、BV/UID、定时策略和截止时间、关联账号、标签（允许替换同一任务的监控目标，不新建任务）
- **FR-018**: 系统MUST允许管理员删除监控任务（历史数据保留）
- **FR-019**: 系统MUST支持任务状态管理：监控中、已停止、已完成（达到截止）、失败（超过最大重试）、暂停（因鉴权失败）
- **FR-020**: 系统MUST支持卡片多选（多选/本页全选/全量全选）与批量启用/禁用操作；默认隐藏复选框，悬停显示；进入多选模式时所有卡片显示复选框
- **FR-021**: 卡片右下角MUST提供菜单按钮，点击拉起编辑Modal

#### 数据收集与存储

- **FR-022**: 系统MUST收集视频数据：播放量、实时观看人数、弹幕数、评论数、投币数、点赞数
- **FR-023**: 对于用户持有账号的博主，系统MUST每日收集一次视频私密指标：播放完成率、平均观看时长
- **FR-024**: 系统MUST收集博主粉丝数数据（按日）
- **FR-025**: 系统MUST永久保留所有收集的数据
- **FR-026**: 系统MUST支持从后端API获取视频封面与博主头像，并将其保存到本地缓存；当拉取失败时使用占位图

#### 数据展示与可视化（卡片+内联详情）

- **FR-027**: 列表视图MUST仅提供卡片平铺视图（不提供表格视图），默认每页8条；点击卡片在当前页面下方“内联详情区”展示图表
- **FR-028**: 视频卡片MUST展示：封面（16:9）、标题、播放量（“xx万”格式）
- **FR-029**: 博主卡片MUST展示：头像（1:1）、昵称、粉丝数（“xx万”格式）；布局紧凑

#### 分类与搜索

- **FR-030**: 系统MUST支持按博主与对象类型（视频/博主）分类展示监控任务
- **FR-031**: 系统MUST支持自定义标签（多选）并按标签筛选
- **FR-032**: 系统MUST支持关键字搜索（BV/UID/标题/博主名）

#### 标签输入

- **FR-033**: 标签输入MUST支持：模糊搜索已有标签、键盘上下键选择候选、回车或逗号确认添加、悬停显示删除按钮
- **FR-034**: 标签约束：单个标签长度≤20；每个任务最多10个；允许中文与空格；大小写原样保存

#### 通知与告警

- **FR-035**: 系统MUST支持以下告警触发：
  - 粉丝数突增/突降超过设定阈值（每博主独立配置，默认关闭）
  - 视频指标达到设定阈值
  - 监控任务超过最大重试次数失败
  - B站账号鉴权连续失败>5次（产生暂停与恢复流程）
- **FR-036**: 系统MUST支持通知渠道：邮件、钉钉、企业微信、Webhook、Bark、PushDeer、OneBot QQ、Telegram
- **FR-037**: 系统MUST允许为每类告警配置是否推送以及接收目标。
- **FR-038**: 系统MUST支持创建、编辑和删除通知规则，规则应包含名称、触发器（如任务停止、鉴权失败）、目标渠道（多选）和启用状态。
- **FR-039**: 粉丝告警阈值MUST支持“绝对值/百分比”两种模式，默认关闭，默认对比窗口24小时。

#### 日志记录

- **FR-039**: 系统MUST支持按以下条件筛选日志：日期范围（起始/结束）、等级（多选）、来源（多选）、关键字（消息内容匹配）。
- **FR-040**: 系统MUST支持按时间升序或降序对日志进行排序。
- **FR-041**: 系统MUST提供基于当前筛选条件的日志下载功能。
- **FR-042**: 日志记录等级至少包含 DEBUG、INFO、WARNING、ERROR。
- **FR-043**: 日志内容需包含时间戳、等级、来源和消息。

#### UI/UX

- **FR-044**: 系统MUST采用左侧导航+主内容区的布局，风格参考 shadcn/ui；深色模式下文字/边框/背景达到良好对比。
- **FR-045**: 固定频率输入MUST采用“数字输入框+单位下拉（分钟/小时/天）”。
- **FR-046**: 详情展示MUST采用内联详情区而非跳转页面。
- **FR-047**: 标签输入和展示MUST使用 `Badge` 样式的组件。
- **FR-048**: 日期选择器MUST使用 `DatePicker` 组件，提供弹窗式日历选择。

### 数据与校验规则（关键）

- **BV号**：字符串（前端不强制格式校验；后端可在可用时进行宽松校验）
- **UID**：字符串（前端不强制限制为正整数；后端可在可用时进行宽松校验）
- **固定频率**：换算后≥1分钟；最大值≤系统设置上限（默认1天）

### Key Entities

- **User**: 用户（用户名、密码、角色）
- **BiliAccount**: B站账号（UID、Cookie/登录凭据、绑定方式（Cookie/扫码）、绑定时间、状态（有效/过期）、最近失败次数）
- **MonitoringTask**: 监控任务（taskId[内部唯一ID]、类型（视频/博主）、目标ID（BV/UID字符串）、标题/昵称、关联账号、定时策略、截止时间、状态（监控中/已停止/已完成/失败/暂停）、创建时间、标签列表、暂停原因）
  - 注：taskId 不使用 BV/UID 作为主键；允许在同一 taskId 下替换目标ID（需记录变更事件）
- **VideoData**: 视频数据（视频ID、采集时间、播放量、在线观看、弹幕、评论、投币、点赞、（可选）播放完成率、平均观看时长）
- **AuthorData**: 博主数据（UID、采集时间、粉丝数）
- **MediaAsset**: 媒体资源（目标类型、目标ID、封面/头像本地路径、来源URL、最后刷新时间、状态）
- **Notification**: 通知配置（渠道、目标、启用）
- **AlertRule**: 告警规则（类型、阈值模式（绝对/百分比）、阈值、窗口、启用）
- **SystemLog**: 日志（时间戳、等级、来源、详情）

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理员5分钟内完成系统登录并通过Cookie或扫码完成账号绑定
- **SC-002**: 管理员2分钟内添加一个新任务
- **SC-003**: 列表仅卡片视图下，卡片点击至详情区首次渲染≤2秒，切换不同卡片至详情区≤1秒
- **SC-004**: 批量启停支持≥200条选中项在10秒内完成调度（异步批处理，有进度反馈）
- **SC-005**: 智能/固定频率调度准确，固定频率最小1分钟生效
- **SC-006**: 账号连续失败>5次后100%触发“统一暂停+标记+通知”，重新登录后出现恢复提示，恢复成功率≥95%
- **SC-007**: 播放量展示在卡片端统一为“xx万”格式，用户无困惑反馈
- **SC-008**: 媒体资源（封面/头像）获取失败时占位图显示正确，重试后能正常替换
- **SC-009**: 深色模式下图表采用ECharts默认深色主题；所有页面文本与背景对比度满足可读性（对比度≥4.5:1）

---

## Assumptions

1. B站登录二维码URL可通过后端调用官方/公开接口获取，扫码后可换取可用凭据
2. 出于安全考虑，Cookie与登录凭据以加密形式存储；日志中不落地敏感原文
3. 媒体资源本地缓存存在有效期（例如7天），到期自动刷新；失败使用占位图
4. 队列采用全局单并发，避免并发触发风控；大量任务将导致等待延迟，用户预期可接受
5. 所有时间展示采用北京时间（UTC+8）

---

## Notes

- 本规范已根据最新原型要求：仅卡片视图、内联详情区、封面/头像展示、批量启停、扫码登录、用户管理、主题与深色模式、交互式标签输入等进行更新
- 图表深色主题采用 ECharts 默认 dark 主题
- MonitoringTask 使用内部唯一ID作为主键，不使用BV/UID
