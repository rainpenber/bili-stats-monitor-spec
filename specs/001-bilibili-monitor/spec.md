# Feature Specification: B站数据监控工具 - 核心功能

**Feature Branch**: `001-bilibili-monitor`  
**Created**: 2025-11-26  
**Status**: Draft  
**Input**: 面向视频博主的B站数据监控Web工具，支持视频和粉丝数据监控

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 管理员登录并绑定/扫码登录B站账号 (Priority: P1)

管理员用户通过系统登录，并将其拥有的B站账号绑定到系统中。绑定方式支持两种：
- 方式A：输入Cookie（包含SESSDATA）
- 方式B：扫码登录（弹出Modal展示B站官方登录二维码，扫码后后端保存登录凭据）

**Why this priority**: 无B站账号绑定将无法获取私密或更完整的数据。

**Independent Test**: 分别测试Cookie方式与扫码方式绑定流程；完成后可用该账号凭据调用受限接口完成一次验证查询。

**Acceptance Scenarios**:

1. **Given** 管理员未登录, **When** 访问系统首页, **Then** 重定向到登录页面
2. **Given** 管理员在登录页面, **When** 输入正确的用户名和密码并登录, **Then** 进入仪表板
3. **Given** 管理员已登录, **When** 在账号管理中选择“输入Cookie绑定”并输入包含SESSDATA的Cookie, **Then** 验证通过后保存
4. **Given** 管理员已登录, **When** 在账号管理中选择“扫码登录绑定”，系统获取登录二维码URL并展示Modal, **Then** 用户扫码后显示绑定成功并保存凭据
5. **Given** 管理员输入无效Cookie或扫码失败, **When** 提交, **Then** 显示错误提示并拒绝保存

---

### User Story 2 - 管理员添加监控任务（卡片视图，内联详情）(Priority: P1)

管理员可以添加“视频”或“博主”的监控任务，系统根据定时策略采集数据。列表采用卡片平铺视图，点击卡片即可在当前页面下方的“详情区”展示图表与详情，无需跳页。

**Why this priority**: 任务添加与快速查看详情是核心使用场景。

**Independent Test**: 测试添加任务、卡片展示封面/头像、点击卡片拉起下方详情区展示图表。

**Acceptance Scenarios**:

1. **Given** 管理员已登录, **When** 点击“添加监控任务”, **Then** 弹出表单
2. **Given** 选择任务类型为“视频”并输入BV号, **When** 提交, **Then** 系统校验BV格式（以“BV”开头，字母数字混合），成功后创建任务
3. **Given** 任务已创建, **When** 返回卡片列表, **Then** 新卡片显示视频封面（16:9）与标题、仅显示播放量（其他指标不在卡片上显示）
4. **Given** 在卡片列表, **When** 点击任一视频卡片, **Then** 页面下方“详情区”展开并显示两张图表（播放量+在线观看；互动数据），再次点击其它卡片可快速切换详情区内容
5. **Given** 在卡片操作中, **When** 需要删除任务, **Then** 只能通过“编辑任务”Modal中的删除按钮完成（卡片本身不显示“删除”）
6. **Given** 任务类型为“博主”, **When** 成功创建, **Then** 卡片显示博主头像（1:1）与昵称、粉丝数；点击卡片在下方详情区显示粉丝折线图

---

### User Story 3 - 普通用户查看仪表板与数据（卡片+内联详情）(Priority: P1)

普通用户以只读方式查看所有视频与博主的卡片列表与下方内联详情。

**Why this priority**: 主要价值在于随时查看数据趋势。

**Independent Test**: 验证普通用户无法修改任务或系统配置；可点击卡片切换下方详情区内容。

**Acceptance Scenarios**:

1. **Given** 普通用户已登录, **When** 进入仪表板, **Then** 显示卡片平铺列表（视频/博主）
2. **Given** 普通用户点击任何卡片, **When** 切换, **Then** 下方详情区展示对应图表（视频：两图；博主：粉丝图）
3. **Given** 普通用户在卡片上, **When** 尝试编辑, **Then** 显示权限不足提示

---

### User Story 4 - 管理员编辑任务与批量启停 (Priority: P2)

管理员可编辑任务（定时策略、截止时间、关联账号、标签），删除操作仅在编辑Modal内进行。提供卡片多选（支持本页全选、跨页全选），支持批量“启用/禁用（启动/停止）”。

**Why this priority**: 提高运维效率，减少重复操作。

**Independent Test**: 验证编辑流程、删除在编辑Modal中的位置、批量选择与批量启停。

**Acceptance Scenarios**:

1. **Given** 管理员在列表, **When** 打开某任务编辑Modal, **Then** 可修改策略/截止/关联账号/标签，并可在Modal内执行删除
2. **Given** 管理员需要批量操作, **When** 通过卡片左上角复选框多选/本页全选/全量全选, **Then** 点击工具栏“启用/禁用”对所选任务生效
3. **Given** 批量操作执行, **When** 成功, **Then** 展示结果汇总（成功/失败项数量）

---

### User Story 5 - 账号过期处理与任务恢复 (Priority: P2)

当某B站账号鉴权失败次数 > 5 次，系统暂停该账号关联的所有任务，并为这些任务打上“因鉴权失败暂停”的标记；管理员完成重新登录（Cookie或扫码）后，系统询问是否恢复这些被标记的任务。

**Why this priority**: 明确过期后的处置策略与恢复体验。

**Independent Test**: 模拟鉴权连续失败>5，查看任务统一暂停与标记；重新登录后出现“是否恢复”提示并可一键恢复。

**Acceptance Scenarios**:

1. **Given** 同一账号连续鉴权失败>5, **When** 系统检测到, **Then** 暂停该账号关联所有任务并标记原因；发送告警通知
2. **Given** 管理员完成账号重新登录, **When** 返回系统, **Then** 弹窗询问是否恢复此前被标记暂停的任务（可全选/部分选择）
3. **Given** 管理员选择恢复, **When** 确认, **Then** 被标记任务恢复为“监控中”，并清除暂停标记

---

### User Story 6 - 分类、搜索与卡片视图唯一制 (Priority: P2)

仅提供卡片视图（不提供表格视图）；支持按博主、对象类型（视频/博主）、标签筛选；支持关键词搜索（BV/UID/标题/博主名）。

**Why this priority**: 简化交互，聚焦常用视图。

**Independent Test**: 验证卡片筛选与搜索在无表格视图情况下的可用性。

**Acceptance Scenarios**:

1. **Given** 用户在仪表板/列表, **When** 使用分类筛选与搜索, **Then** 卡片列表正确过滤
2. **Given** 用户需要切换视图, **When** 查看选项, **Then** 不提供表格视图，仅保留卡片

---

### User Story 7 - 系统记录日志与通知 (Priority: P3)

按既定规则记录日志（DEBUG/INFO/WARNING）并在账号过期、批量操作结果等场景通知管理员。

**Why this priority**: 可观察性与可运维性。

**Independent Test**: 触发关键事件并检查日志/通知内容与口径。

**Acceptance Scenarios**:

1. **Given** 系统发生账号过期、批量操作等事件, **When** 记录日志, **Then** 等级口径符合规范
2. **Given** 触发告警事件, **When** 已配置渠道, **Then** 通知成功发送

---

### Edge Cases

- **账号Cookie/二维码登录凭据过期**: 连续失败>5触发统一暂停与标记
- **监控任务超过3个月**: 到期自动停止并记录日志
- **数据抓取队列堆积**: 采用全局单并发与FIFO，必要时提示延迟风险
- **网络中断/接口变更**: 失败重试与警示
- **图像获取失败**: 使用占位图并记录WARNING

---

## Requirements *(mandatory)*

### Functional Requirements

#### 账号与权限管理

- **FR-001**: 系统MUST支持两种用户角色：管理员和普通用户
- **FR-002**: 管理员MUST能够通过用户名和密码登录系统
- **FR-003**: 普通用户MUST能够通过相同的登录方式访问系统
- **FR-004**: 系统MUST允许管理员绑定B站账号（方式A：输入Cookie（含SESSDATA）；方式B：扫码登录Modal展示官方二维码，扫码后保存凭据）
- **FR-005**: 系统MUST验证绑定凭据有效性，无效时拒绝保存并显示错误提示
- **FR-006**: 当同一账号连续鉴权失败>5次时，系统MUST暂停该账号关联的所有监控任务并打上“因鉴权失败暂停”的标记，同时发送告警通知
- **FR-007**: 管理员完成账号重新登录后，系统MUST询问是否恢复此前被标记暂停的任务，并支持一键恢复
- **FR-008**: 普通用户MUST无法修改任务配置或系统设置
- **FR-009**: 系统设置中MUST提供用户管理：仅两位用户（管理员/普通），管理员可修改自己与普通用户密码，普通用户仅能修改自己的密码

#### 监控任务管理（卡片+内联详情）

- **FR-010**: 系统MUST支持两种监控任务类型：视频、博主
- **FR-011**: 系统MUST为每个监控任务可选关联一个B站账号（用于鉴权；未关联则仅获取公开数据）
- **FR-012**: 系统MUST支持两种定时策略：
  - 固定频率：采用“数字+单位（分钟/小时/天）”的组合输入，换算后不得小于1分钟；最大值受系统设置控制（默认1天）
  - 智能频率（视频）：以视频发布时间为起点，分为自然时间段：
    - 段A：[发布时刻, +5天) → 每10分钟
    - 段B：[+5天, +14天) → 每2小时
    - 段C：[+14天, 截止] → 每4小时
- **FR-013**: 系统MUST为每个监控任务设置3个月的默认截止时间，超过截止时间后自动停止监控
- **FR-014**: 系统MUST允许管理员修改监控任务的定时策略和截止时间、关联账号、标签；删除操作仅在编辑Modal内提供
- **FR-015**: 系统MUST支持任务状态管理：监控中、已停止、已完成（达到截止）、失败（超过最大重试）、暂停（因鉴权失败）
- **FR-016**: 系统MUST支持卡片多选（多选/本页全选/全量全选）与批量启用/禁用操作
- **FR-017**: 系统MUST使用队列机制处理数据抓取，确保同一时间仅有一个抓取在执行（全局单并发）

#### 数据收集与存储

- **FR-018**: 系统MUST收集视频数据：播放量、实时观看人数、弹幕数、评论数、投币数、点赞数
- **FR-019**: 对于用户持有账号的博主，系统MUST每日收集一次视频私密指标：播放完成率、平均观看时长
- **FR-020**: 系统MUST收集博主粉丝数数据（按日）
- **FR-021**: 系统MUST永久保留所有收集的数据
- **FR-022**: 系统MUST支持从后端API获取视频封面与博主头像，并将其保存到本地缓存；当拉取失败时使用占位图

#### 数据展示与可视化（卡片+内联详情）

- **FR-023**: 列表视图MUST仅提供卡片平铺视图（不提供表格视图）
- **FR-024**: 视频卡片MUST展示：封面（16:9）、标题、播放量（“xx万”格式）、状态、标签、最后采集时间（可选）
- **FR-025**: 博主卡片MUST展示：头像（1:1）、昵称、粉丝数、状态、标签、最后采集时间（可选）
- **FR-026**: 点击卡片MUST在当前页面下方“详情区”展示图表：
  - 视频：折线图1（播放量+在线观看人数）；折线图2（弹幕/评论/投币/点赞）
  - 博主：粉丝数折线图（加载全量，默认缩放近3个月，Y轴可见数据±500）
- **FR-027**: 播放量数值在展示端MUST采用“xx万”友好格式（≥10000，保留1位小数）

#### 分类与搜索

- **FR-028**: 系统MUST支持按博主与对象类型（视频/博主）分类展示监控任务
- **FR-029**: 系统MUST支持自定义标签（多选）并按标签筛选
- **FR-030**: 系统MUST支持关键字搜索（BV/UID/标题/博主名）

#### 通知与告警

- **FR-031**: 系统MUST支持以下告警触发：
  - 粉丝数突增/突降超过设定阈值（每博主独立配置，默认关闭）
  - 视频指标达到设定阈值
  - 监控任务超过最大重试次数失败
  - B站账号鉴权连续失败>5次（产生暂停与恢复流程）
- **FR-032**: 系统MUST支持通知渠道：邮件、钉钉、企业微信、Webhook、Bark、PushDeer、OneBot QQ、Telegram
- **FR-033**: 系统MUST允许为每类告警配置是否推送以及接收目标
- **FR-034**: 粉丝告警阈值MUST支持“绝对值/百分比”两种模式，默认关闭，默认对比窗口24小时

#### 日志记录

- **FR-035**: 系统MUST记录三个等级的日志：DEBUG、INFO、WARNING
- **FR-036**: DEBUG需记录抓取关键步骤（敏感信息脱敏）
- **FR-037**: INFO需记录抓取、任务启停、批量操作、通知发送等事件
- **FR-038**: WARNING需记录抓取失败、通知失败、鉴权过期等异常
- **FR-039**: 日志MUST按日期滚动保存并允许下载

#### UI/UX

- **FR-040**: 系统MUST采用左侧导航+主内容区的布局，风格参考 shadcn/ui
- **FR-041**: 固定频率输入MUST采用“数字输入框+单位下拉（分钟/小时/天）”
- **FR-042**: 详情展示MUST采用内联详情区而非跳转页面

### 数据与校验规则（关键）

- **BV号**：字符串，格式满足以“BV”开头，余下为大小写字母与数字组合（示例：^BV[0-9A-Za-z]+$）
- **UID**：正整数
- **固定频率**：换算后≥1分钟；最大值≤系统设置上限（默认1天）

### Key Entities

- **User**: 用户（用户名、密码、角色）
- **BiliAccount**: B站账号（UID、Cookie/登录凭据、绑定方式（Cookie/扫码）、绑定时间、状态（有效/过期）、最近失败次数）
- **MonitoringTask**: 监控任务（ID、类型（视频/博主）、目标ID（BV/UID）、关联账号、定时策略、截止时间、状态（监控中/已停止/已完成/失败/暂停）、创建时间、标签列表、暂停原因）
- **VideoData**: 视频数据（视频ID、采集时间、播放量、在线观看、弹幕、评论、投币、点赞、（可选）播放完成率、平均观看时长）
- **AuthorData**: 博主数据（UID、采集时间、粉丝数）
- **MediaAsset**: 媒体资源（目标类型、目标ID、封面/头像本地路径、来源URL、最后刷新时间、状态）
- **Notification**: 通知配置（渠道、目标、启用）
- **AlertRule**: 告警规则（类型、阈值模式（绝对/百分比）、阈值、窗口、启用）
- **SystemLog**: 日志（时间戳、等级、来源、详情）

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理员5分钟内完成系统登录并通过Cookie或扫码完成账号绑定
- **SC-002**: 管理员2分钟内添加一个新任务
- **SC-003**: 列表仅卡片视图下，卡片点击至详情区首次渲染≤2秒，切换不同卡片至详情区≤1秒
- **SC-004**: 批量启停支持≥200条选中项在10秒内完成调度（异步批处理，有进度反馈）
- **SC-005**: 智能/固定频率调度准确，固定频率最小1分钟生效
- **SC-006**: 账号连续失败>5次后100%触发“统一暂停+标记+通知”，重新登录后出现恢复提示，恢复成功率≥95%
- **SC-007**: 播放量展示在卡片端统一为“xx万”格式，用户无困惑反馈
- **SC-008**: 媒体资源（封面/头像）获取失败时占位图显示正确，重试后能正常替换

---

## Assumptions

1. B站登录二维码URL可通过后端调用官方/公开接口获取，扫码后可换取可用凭据
2. 出于安全考虑，Cookie与登录凭据以加密形式存储；日志中不落地敏感原文
3. 媒体资源本地缓存存在有效期（例如7天），到期自动刷新；失败使用占位图
4. 队列采用全局单并发，避免并发触发风控；大量任务将导致等待延迟，用户预期可接受
5. 所有时间展示采用北京时间（UTC+8）

---

## Notes

- 本规范已根据最新原型要求：仅卡片视图、内联详情区、封面/头像展示、批量启停、扫码登录、用户管理等进行更新
- 后续API设计将覆盖媒体资源获取/缓存、扫码登录轮询、批量任务操作、内联详情数据接口
