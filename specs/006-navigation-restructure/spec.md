# Feature Specification: 前端导航结构重组

**Feature Branch**: `006-navigation-restructure`  
**Created**: 2025-12-28  
**Status**: Draft  
**Input**: 试用了当前的前端界面后,感觉功能区域划分不是很合理。目前是 仪表板、账号管理、通知设置等等。实际上除了第一个,剩下的都是设置功能。所以在左边的功能就划分为三个菜单选项。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看当前账号的数据概览和监控任务 (Priority: P1)

管理员登录后,想快速查看当前选择账号的核心数据(粉丝数、视频监控数量),以及该账号相关的所有视频监控任务。

**Why this priority**: 这是用户的主要工作流,能让用户立即看到最关心的账号信息和监控数据,是系统的核心价值所在。

**Independent Test**: 可以通过登录系统,切换到"我的账号"页面,验证是否能看到账号信息、数据仪表板、粉丝图表和视频任务卡片。

**Acceptance Scenarios**:

1. **Given** 用户已绑定至少一个B站账号, **When** 用户访问"我的账号"页面, **Then** 页面顶部显示当前选择的账号信息和"切换账号"按钮
2. **Given** 用户在"我的账号"页面, **When** 页面加载完成, **Then** 显示数据仪表板,包含监视视频总数和当前账号粉丝量数字
3. **Given** 用户在"我的账号"页面, **When** 页面滚动到粉丝图表区域, **Then** 显示该账号的粉丝数量变化折线图
4. **Given** 用户在"我的账号"页面, **When** 页面滚动到底部, **Then** 显示所有发布者为该账号的视频监控任务卡片列表

---

### User Story 2 - 切换不同账号查看对应数据 (Priority: P1)

用户在"我的账号"页面,想切换到其他已绑定的账号,查看该账号的数据。

**Why this priority**: 多账号管理是核心功能,用户需要频繁切换账号查看不同账号的数据,这是P1用户故事的重要补充。

**Independent Test**: 可以通过点击"切换账号"按钮,在弹出的账号列表中选择其他账号,验证页面数据是否更新为新账号的数据。

**Acceptance Scenarios**:

1. **Given** 用户已绑定多个B站账号且在"我的账号"页面, **When** 用户点击"切换账号"按钮, **Then** 弹出Modal显示所有已绑定账号的列表
2. **Given** 账号切换Modal已打开, **When** 用户点击列表中的某个账号, **Then** Modal关闭,页面数据更新为所选账号的数据
3. **Given** 用户切换账号后, **When** 页面重新加载数据, **Then** 数据仪表板、粉丝图表和视频任务列表都显示新账号的数据
4. **Given** 用户只绑定了一个账号, **When** 用户点击"切换账号"按钮, **Then** Modal显示唯一的账号,同时提示可以前往系统设置绑定更多账号

---

### User Story 3 - 浏览和管理所有监控任务 (Priority: P2)

用户想查看系统中所有的视频监控任务(不限于某个账号),包括任务状态、数据统计,并能执行筛选、搜索和管理操作。

**Why this priority**: 这是原有的核心功能,需要保留但优先级略低于账号维度的视图。用户在需要全局视角时会使用此功能。

**Independent Test**: 可以通过访问"监视任务"页面,验证是否能看到所有监控任务的卡片列表,以及筛选、搜索功能是否正常工作。

**Acceptance Scenarios**:

1. **Given** 系统中存在多个监控任务, **When** 用户访问"监视任务"页面, **Then** 显示所有任务的卡片列表(原仪表板内容)
2. **Given** 用户在"监视任务"页面, **When** 用户输入关键词搜索, **Then** 任务列表根据搜索条件过滤显示
3. **Given** 用户在"监视任务"页面, **When** 用户点击任务卡片, **Then** 显示该任务的详细监控数据
4. **Given** 用户在"监视任务"页面, **When** 用户使用类型筛选器, **Then** 任务列表只显示符合筛选条件的任务

---

### User Story 4 - 管理B站账号绑定 (Priority: P2)

用户在系统设置中,想查看所有已绑定的B站账号,进行绑定新账号、解绑账号、设置全局默认账号等操作。

**Why this priority**: 账号管理是基础设施功能,频率较低但很重要。整合到系统设置中能让界面更清晰。

**Independent Test**: 可以通过访问"系统设置 > 账号管理"页面,验证能否查看账号列表、绑定新账号、解绑账号、设置默认账号。

**Acceptance Scenarios**:

1. **Given** 用户在系统设置页面, **When** 用户点击"账号管理"子菜单, **Then** 显示账号管理页面,包含已绑定账号列表和"绑定新账号"按钮
2. **Given** 用户在账号管理页面, **When** 用户点击"绑定新账号"按钮, **Then** 弹出绑定Modal(支持Cookie绑定或扫码登录)
3. **Given** 用户在账号管理页面, **When** 用户点击某个账号的"解绑"按钮, **Then** 弹出确认对话框,确认后解绑该账号
4. **Given** 用户在账号管理页面, **When** 用户在"全局默认账号"区域选择某个账号并保存, **Then** 该账号被设置为系统默认账号(用于抓取非该博主自己的视频数据)
5. **Given** 系统中某个视频任务的发布者没有对应的已绑定账号, **When** 系统抓取该任务数据时, **Then** 使用全局默认账号的Cookie进行抓取

---

### User Story 5 - 配置系统通知和查看日志 (Priority: P3)

用户在系统设置中,想配置通知规则、查看系统日志。

**Why this priority**: 这些是支持性功能,使用频率较低,但对系统运维和监控很重要。

**Independent Test**: 可以通过访问"系统设置 > 通知设置"和"系统设置 > 日志"页面,验证相关功能是否正常。

**Acceptance Scenarios**:

1. **Given** 用户在系统设置页面, **When** 用户点击"通知设置"子菜单, **Then** 显示通知配置页面(保持原有功能不变)
2. **Given** 用户在系统设置页面, **When** 用户点击"日志"子菜单, **Then** 显示系统日志页面(保持原有功能不变)

---

### User Story 6 - 自定义系统外观和修改密码 (Priority: P3)

用户在系统设置中,想调整主题色、配色方案,以及修改管理员密码。

**Why this priority**: 个性化和安全设置,使用频率最低但对用户体验和安全性有价值。

**Independent Test**: 可以通过访问"系统设置 > 其他设置"页面,验证主题切换和密码修改功能。

**Acceptance Scenarios**:

1. **Given** 用户在系统设置页面, **When** 用户点击"其他设置"子菜单, **Then** 显示主题色设置、配色方案设置和密码修改表单
2. **Given** 用户在其他设置页面, **When** 用户选择不同的主题色, **Then** 界面主题色立即更新
3. **Given** 用户在其他设置页面, **When** 用户切换配色方案(浅色/深色/跟随系统), **Then** 界面配色方案立即更新
4. **Given** 用户在其他设置页面, **When** 用户输入旧密码和新密码并提交, **Then** 系统验证旧密码正确后更新为新密码,并提示成功

---

### Edge Cases

- 当用户未绑定任何账号时,"我的账号"页面显示什么?
  - 显示空状态提示,引导用户前往"系统设置 > 账号管理"绑定账号
- 当用户解绑了当前正在查看的账号时,如何处理?
  - 自动切换到第一个可用的已绑定账号,如果没有其他账号则显示空状态
- 当用户解绑的账号是全局默认账号时,如何处理?
  - 清空全局默认账号设置,并在账号管理页面显示警告提示,要求用户重新设置
- 当系统设置菜单展开时,用户切换到其他一级菜单,系统设置是否应该自动收起?
  - 是,切换到其他一级菜单时,系统设置自动收起
- 当用户在"我的账号"页面切换账号后,浏览器刷新,是否记住用户的选择?
  - 是,使用localStorage记住用户最后选择的账号ID,刷新后自动加载该账号数据
- 当某个账号的Cookie已过期时,相关数据如何显示?
  - 在账号管理页面标记该账号为"已过期"状态,在"我的账号"页面显示提示,引导用户重新绑定
- 当默认展示的博主没有对应的已绑定账号时,如何处理?
  - 允许显示,但只能展示公开数据(粉丝数、视频列表等),无法显示需要鉴权的隐私数据,并在UI上明确标注数据限制
- 当默认展示的博主对应的监控任务被删除后,如何处理?
  - 博主列表不再显示该博主,如果该博主是当前默认展示的博主,页面刷新后fallback到当前选择账号对应的博主
- 当用户在"我的账号"页面选择博主后,浏览器刷新,是否记住当前展示的博主?
  - 否,当前展示博主是临时选择,刷新后恢复为默认展示博主(如果设置了)或当前选择账号对应的博主

## Requirements *(mandatory)*

### Functional Requirements

#### 导航结构

- **FR-001**: 系统侧边栏导航MUST包含三个一级菜单项:"我的账号"、"监视任务"、"系统设置"
- **FR-002**: "系统设置"菜单项MUST支持展开/收起,展开时显示四个二级菜单:"账号管理"、"通知设置"、"日志"、"其他设置"
- **FR-003**: 当用户点击其他一级菜单时,"系统设置"MUST自动收起;当页面刷新时,如果当前路由是系统设置的子菜单(如/settings/accounts),系统设置菜单MUST自动展开
- **FR-004**: 当前激活的菜单项MUST有视觉高亮显示

#### 我的账号页面

- **FR-005**: "我的账号"页面MUST在顶部显示当前选择的账号信息(昵称、UID、头像)和"切换账号"按钮
- **FR-006**: "切换账号"按钮点击后MUST弹出Modal,显示所有已绑定账号的列表
- **FR-007**: 账号切换Modal中的每个账号项MUST显示账号昵称、UID、头像和状态(有效/已过期)
- **FR-008**: 用户在账号切换Modal中选择账号后,页面MUST更新为所选账号的数据,包括数据仪表板、粉丝图表和视频任务列表
- **FR-009**: "我的账号"页面MUST显示数据仪表板区域,包含两个数据指标:监视视频总数(该账号为发布者的任务数量)、当前粉丝量
- **FR-010**: 数据仪表板的数字MUST以大号字体美观显示,卡片采用固定大小,同行多列排列,左对齐
- **FR-011**: "我的账号"页面MUST显示粉丝数量变化折线图,加载该账号的全部历史粉丝数据,横轴时间默认缩放到最近30天
- **FR-012**: "我的账号"页面MUST显示所有发布者为该账号的视频监控任务卡片列表
- **FR-013**: 视频任务卡片点击后MUST显示该视频的详细监控数据
- **FR-014**: 当用户未绑定任何账号时,"我的账号"页面MUST显示空状态提示和引导链接
- **FR-015**: 系统MUST使用localStorage记住用户最后选择的账号ID,页面刷新后自动加载该账号;如果该账号已被解绑,系统MUST fallback到第一个可用账号,若无可用账号则显示空状态
- **FR-037**: "我的账号"页面MUST提供"选择博主"按钮,点击后弹出Modal显示博主列表
- **FR-038**: 博主选择Modal中的博主列表MUST从authors表查询(仅显示有监控任务的博主,即author_uid存在于tasks表中的博主)
- **FR-039**: 博主选择Modal中的每个博主项MUST显示昵称、UID、头像,以及"设为默认"按钮
- **FR-040**: 博主选择ModalMUST支持按昵称和UID搜索筛选功能
- **FR-041**: 用户在博主选择Modal中选择博主后,页面MUST立即更新为所选博主的数据(当前展示,临时选择)
- **FR-042**: 用户在博主选择Modal中点击"设为默认"按钮后,系统MUST将该博主UID持久化存储到settings表中(key: 'default_display_author')
- **FR-043**: 页面刷新时,MUST优先展示默认展示的博主(从settings表读取default_display_author),如果没有设置则展示当前选择账号对应的博主
- **FR-044**: 如果默认展示的博主没有对应的已绑定账号,系统MUST允许显示但只能展示公开数据(粉丝数、视频列表等),无法显示需要鉴权的隐私数据,并在UI上明确标注数据限制
- **FR-045**: 当前展示博主(临时选择)和默认展示博主(持久化设置)MUST在UI上明确区分,当前展示博主仅在本次会话有效,页面刷新后恢复为默认展示博主

#### 监视任务页面

- **FR-016**: "监视任务"页面MUST保持原"仪表板"页面的所有功能不变
- **FR-017**: "监视任务"页面MUST显示系统中所有监控任务的卡片列表(不限账号)
- **FR-018**: "监视任务"页面MUST支持关键词搜索和类型筛选功能

#### 系统设置 - 账号管理

- **FR-019**: "系统设置 > 账号管理"页面MUST整合原"账号管理"页面和原"系统设置"页面中的"全局默认账号"功能
- **FR-020**: 账号管理页面MUST显示所有已绑定账号的列表,包含账号信息、状态和操作按钮
- **FR-021**: 账号管理页面MUST提供"绑定新账号"按钮,点击后弹出绑定Modal(支持Cookie绑定或扫码登录)
- **FR-022**: 每个账号项MUST提供"解绑"按钮,点击后弹出确认对话框,确认后解绑该账号
- **FR-023**: 账号管理页面MUST包含"全局默认账号"设置区域,允许用户选择一个已绑定账号作为默认账号
- **FR-024**: 当用户解绑全局默认账号时,系统MUST清空默认账号设置,并在页面显示警告提示
- **FR-025**: 账号管理页面MUST标记已过期的账号,并在账号列表中显示"已过期"标签

#### 系统设置 - 其他子菜单

- **FR-026**: "系统设置 > 通知设置"页面MUST保持原有功能不变
- **FR-027**: "系统设置 > 日志"页面MUST保持原有功能不变
- **FR-028**: "系统设置 > 其他设置"页面MUST包含主题色设置、配色方案设置和管理员密码修改功能
- **FR-029**: 主题色设置MUST允许用户选择预设主题(默认、绿色、蓝色、紫色、橙色)
- **FR-030**: 配色方案设置MUST允许用户选择浅色、深色或跟随系统
- **FR-031**: 密码修改功能MUST要求用户输入旧密码和新密码,验证旧密码正确后才能更新

#### 数据抓取逻辑

> **说明**: 数据抓取逻辑的实现位置在`CollectorService`中,本次功能主要涉及数据模型扩展(bili_account_id和author_uid字段),抓取逻辑的三级优先级实现可能需要单独的任务或已在现有代码中实现。

- **FR-032**: 当系统抓取某个任务的数据时,MUST按以下优先级选择账号Cookie: 1) 该任务的bili_account_id字段指定的账号; 2) 检查任务的author_uid是否有对应的已绑定账号(通过accounts.uid = task.author_uid匹配); 3) 使用全局默认账号
- **FR-033**: 如果选中的账号Cookie有效,系统MUST使用该账号的Cookie进行数据抓取
- **FR-034**: 如果所有账号都不可用(未设置或已过期),系统MUST记录错误日志,并在通知中提醒用户配置可用账号
- **FR-035**: 全局默认账号MUST持久化存储在settings表中(key: 'default_account_id'),支持用户在账号管理页面设置和修改
- **FR-036**: 当某个账号的Cookie即将过期(距离过期时间少于7天)时,系统MUST在账号管理页面显示提醒(暂不实现,后续优化)

### Key Entities

> **详细数据模型设计参见**: `data-model.md`（包含表结构、字段约束、索引设计、迁移脚本等）

- **当前选择账号**: 用户在"我的账号"页面当前查看的账号,包含账号ID、昵称、UID、头像、粉丝数、状态(有效/过期);存储在Zustand state中(仅ID),每次切换时重新fetch账号详情
- **全局默认账号**: 系统级设置,存储在settings表中(key: 'default_account_id', value: account_id),用于抓取非该博主自己的视频数据
- **当前展示博主**: 用户在"我的账号"页面当前查看的博主(按UID),临时选择,仅本次会话有效,存储在组件state中,页面刷新后丢失
- **默认展示博主**: 系统级设置,存储在settings表中(key: 'default_display_author', value: author_uid),持久化设置,页面刷新后自动加载;用于控制"我的账号"页面默认展示哪个博主的数据
- **博主信息**: 存储在authors表中,包含UID、昵称、头像等基本信息;从tasks表提取author_uid后,调用B站API获取并缓存到authors表
- **账号绑定记录**: 每个已绑定的B站账号,包含账号信息、Cookie、登录时间、过期状态
- **视频监控任务**: 每个监控任务包含: id(任务ID)、type(video/author)、target_id(BVID/UID)、author_uid(发布者UID,新增字段;对于video任务存储视频作者UID,对于author任务存储博主自己的UID即与target_id相同)、account_id(创建者,保留字段)、bili_account_id(查询用账号,新增字段)、任务配置、数据记录、抓取日志

> **术语说明**: 
> - **博主(Author)**: 被监控的B站UP主,存储在authors表中,通过UID标识
> - **账号(Account)**: 已绑定的B站登录账号,存储在accounts表中,用于数据抓取时的Cookie认证
> - 一个博主可能有对应的已绑定账号(如果该博主自己绑定了账号),也可能没有(仅监控公开数据)

> **Constitution Alignment Hint**  
> 在撰写需求时,建议按以下顺序组织内容,以符合项目宪章:  
> 1. 先描述用户在**前端界面**上的目标、视图与交互(页面/图表/筛选条件等);  
> 2. 然后将这些交互映射为**API 合约**(请求/响应结构、错误码、分页等),在 `specs/` 或 OpenAPI 中体现;  
> 3. 最后再规划支撑这些合约的**后端实现**(以 Bun 运行时为基础的数据流、存储与任务)。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户在"我的账号"页面能在3秒内完成账号切换操作
- **SC-002**: 用户能在2次点击内从任意页面导航到账号管理功能
- **SC-003**: 用户在"我的账号"页面看到的数据仪表板、图表和任务列表能在页面加载后2秒内全部渲染完成
- **SC-004**: 系统设置菜单的展开/收起动画流畅,无明显延迟(小于200ms)
- **SC-005**: 用户首次访问重组后的界面,能在1分钟内理解新的导航结构并找到目标功能
- **SC-006**: 数据抓取逻辑正确率达到100%,即每个任务都使用正确的账号Cookie(发布者账号或默认账号)
- **SC-007**: 当用户绑定或解绑账号后,"我的账号"页面和账号管理页面的状态能在500ms内自动刷新
- **SC-008**: 用户切换账号后,localStorage能立即保存选择,浏览器刷新后能在1秒内恢复到之前选择的账号

## Clarifications

### Session 2025-12-28

- Q: Tasks表缺少author_uid字段，无法按发布者筛选任务，如何解决？ → A: 添加数据库迁移，给tasks表增加author_uid字段（对视频task和博主task都适用）
- Q: 全局默认账号未持久化到数据库，如何实现？ → A: 在settings表中存储default_account_id
- Q: tasks表中account_id字段的语义是什么？与新增的bili_account_id有何区别？ → A: account_id原意为"创建者"，易混淆；新增bili_account_id字段表示"查询用账号"，保留account_id避免破坏现有系统
- Q: localStorage存储选中账号ID后，如果账号被解绑如何处理？ → A: 实现fallback逻辑：检查ID是否存在 → 否则选第一个可用账号 → 否则显示空状态
- Q: Zustand state中是否缓存selectedAccount对象？ → A: 方案A：只存ID，每次从API获取（实时性好）
- Q: 系统设置菜单在刷新页面后，如果当前路由是子菜单是否自动展开？ → A: 自动展开（提升UX）
- Q: 数据仪表板是否需要显示变化趋势和小图表？ → A: 暂不需要变化趋势，卡片同行多列左对齐，固定大小
- Q: 粉丝图表默认展示多长时间的数据？ → A: 加载全部数据，横轴时间缩放到最近30天（与现有实现保持一致）
- Q: 对于type='author'的博主监控任务，author_uid字段应该存储什么值？ → A: 存储博主自己的UID（与target_id相同），便于统一查询

### Session 2025-12-28 (博主选择功能)

- Q: 默认展示博主的数据存储格式是什么？ → A: 存储UID（博主标识符，字符串），存储在settings表中(key: 'default_display_author')
- Q: 博主列表从哪里获取？ → A: 从tasks表中提取所有不同的author_uid（仅显示有监控任务的博主）
- Q: 当前展示博主和默认展示博主的区别是什么？ → A: 当前展示是临时选择（仅本次会话），默认展示是持久化设置（页面刷新后自动加载）
- Q: 页面刷新时应该展示哪个博主？ → A: 优先展示默认展示的博主，如果没有设置则展示当前选择账号对应的博主
- Q: 如果默认展示的博主没有已绑定账号，如何处理？ → A: 允许选择，但只能显示公开数据（粉丝数、视频列表等），无法显示需要鉴权的隐私数据
- Q: Modal中博主列表需要显示哪些信息？ → A: 仅昵称、UID、头像
- Q: 搜索筛选功能支持哪些字段？ → A: 支持按昵称和UID搜索
- Q: "默认展示"标签如何设置？ → A: 每个博主项右侧有一个"设为默认"按钮/图标，点击后设置为默认展示

## Assumptions

- 假设现有的账号绑定、数据抓取、任务管理等后端API基本稳定，但需要进行数据模型扩展（tasks表增加author_uid和bili_account_id字段）
- 假设用户已经理解B站账号绑定和Cookie的概念,不需要在界面上进行额外的科普说明
- 假设系统中最多同时绑定10个B站账号,账号切换Modal的列表设计基于此假设
- 假设粉丝数据每小时更新一次,图表展示的是小时级别的历史数据
- 假设视频任务卡片的设计和原仪表板保持一致,不需要重新设计UI组件
- 假设账号过期判断基于Cookie的有效期,后端需要提供账号状态的API
- 假设用户使用的是现代浏览器(Chrome/Firefox/Safari最新版本),支持localStorage和CSS Grid布局

## Dependencies

- 后端需要提供API:
  - 获取某个账号(按UID)的粉丝数量和历史数据
  - 获取某个账号为发布者的所有视频任务(按author_uid筛选)
  - 获取/设置全局默认账号(从settings表读写)
  - 检查账号Cookie有效性和过期状态
  - 获取博主列表(从authors表查询,支持按昵称和UID搜索筛选,返回昵称、UID、头像等信息)
  - 同步博主信息(调用B站API获取博主昵称和头像,更新authors表)
  - 获取/设置默认展示博主(从settings表读写default_display_author)
- 后端需要扩展数据模型:
  - **新建authors表**: 存储博主基本信息(uid主键, nickname, avatar, updated_at, created_at)
  - tasks表添加author_uid字段(TEXT类型,NOT NULL;对于type='video'任务存储视频发布者UID,对于type='author'任务存储博主自己的UID即与target_id相同)
  - tasks表添加bili_account_id字段(TEXT类型,存储查询用账号ID,可为NULL)
  - settings表添加default_account_id记录(key-value存储)
  - settings表添加default_display_author记录(key-value存储,value为博主UID)
- 前端需要实现可折叠的导航菜单组件
- 前端需要实现账号切换Modal组件
- 前端需要实现数据仪表板组件(大数字卡片)
- 前端需要实现状态管理(Zustand),记录当前选择的账号ID
- 前端需要实现博主选择Modal组件(包含搜索筛选、"设为默认"功能)
- 前端需要实现当前展示博主的状态管理(组件state,临时选择)
- 后端需要实现B站API客户端扩展: 添加getUserInfo方法获取用户昵称和头像
- 后端需要实现B站API客户端扩展: 添加getUserInfo方法获取用户昵称和头像

## Out of Scope

- 本需求不涉及账号绑定流程的修改(Cookie绑定和扫码登录保持原有实现)
- 本需求不涉及视频任务创建和编辑功能的修改
- 本需求不涉及通知规则和日志查看功能的重构
- 本需求不涉及数据抓取调度逻辑的底层优化
- 本需求不涉及移动端适配(假设仅针对桌面端浏览器)
- 本需求不涉及账号权限管理(假设所有已绑定账号权限相同)
- 本需求不涉及批量操作功能(如批量解绑账号)
