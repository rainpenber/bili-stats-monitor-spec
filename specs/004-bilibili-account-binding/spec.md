# Feature Specification: B站账号绑定功能

**Feature Branch**: `004-bilibili-account-binding`  
**Created**: 2025-12-27  
**Status**: Draft  
**Input**: 用户描述："绑定B站账号的modal未开发完全，还有mock内容，未对接相关api。支持Cookie绑定或扫码登录绑定。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Cookie方式绑定B站账号 (Priority: P1)

管理员或用户需要通过浏览器导出的B站Cookie来绑定账号，以便系统能够代表该账号获取数据。这是最快速、技术门槛最低的绑定方式。

**Why this priority**: Cookie绑定是最直接的认证方式，不需要额外的扫码流程，适合技术用户快速完成账号绑定，是MVP的核心功能。

**Independent Test**: 用户在"绑定B站账号"对话框中粘贴有效Cookie，点击保存，系统验证Cookie有效性并保存绑定信息，用户可立即使用该账号创建监控任务。

**Acceptance Scenarios**:

1. **Given** 用户已登录系统并打开"绑定B站账号"对话框，**When** 用户选择"Cookie绑定"标签页并粘贴有效的B站Cookie字符串后点击"保存"，**Then** 系统验证Cookie有效性，保存绑定关系，显示成功消息并关闭对话框
2. **Given** 用户粘贴了无效或过期的Cookie，**When** 点击"保存"按钮，**Then** 系统返回验证失败错误，提示用户Cookie无效或已过期，需要重新获取
3. **Given** 用户已成功绑定一个B站账号，**When** 尝试绑定相同的账号，**Then** 系统检测到重复绑定，提示该账号已绑定并显示绑定时间
4. **Given** 用户正在绑定过程中，**When** 点击"取消"按钮，**Then** 系统放弃当前输入，关闭对话框，不保存任何数据

---

### User Story 2 - 扫码方式绑定B站账号 (Priority: P2)

用户希望通过B站App扫码的方式完成账号绑定，这种方式更安全，无需手动获取Cookie，适合非技术用户。

**Why this priority**: 扫码登录是更友好、更安全的绑定方式，但依赖B站登录API的完整实现，作为增强功能提升用户体验。

**Independent Test**: 用户在"绑定B站账号"对话框中选择"扫码登录"，系统生成二维码，用户使用B站App扫码并确认授权，系统自动完成绑定。

**Acceptance Scenarios**:

1. **Given** 用户已登录系统并打开"绑定B站账号"对话框，**When** 用户选择"扫码登录"标签页，**Then** 系统调用B站登录API生成二维码并显示在界面上，同时显示"请使用B站App扫码登录"提示
2. **Given** 二维码已生成并显示，**When** 用户使用B站App扫描二维码，**Then** 系统每2秒轮询一次扫码状态，当检测到"已扫码"状态时更新界面提示为"等待确认"
3. **Given** 用户已扫码并在App中点击"确认登录"，**When** 系统轮询检测到"已确认"状态，**Then** 系统获取授权凭证，保存绑定关系，显示成功消息并自动关闭对话框
4. **Given** 二维码已生成超过2分钟，**When** 系统轮询检测到二维码已过期，**Then** 系统显示"二维码已过期"提示，并显示"重新获取二维码"按钮
5. **Given** 二维码已过期，**When** 用户点击"重新获取二维码"按钮，**Then** 系统重新调用API生成新的二维码并重置轮询状态

---

### User Story 3 - 查看和管理已绑定账号 (Priority: P3)

用户需要能够查看当前已绑定的B站账号列表，了解每个账号的绑定状态（有效/过期），并能够解绑或重新绑定过期的账号。

**Why this priority**: 账号管理功能是完整用户体验的一部分，但不阻碍核心绑定流程，可以在基础绑定功能完成后再实现。

**Independent Test**: 用户在账号设置页面查看已绑定的B站账号列表，看到账号名称、绑定时间和状态，可以点击"解绑"按钮移除绑定。

**Acceptance Scenarios**:

1. **Given** 用户已绑定至少一个B站账号，**When** 用户访问账号设置页面，**Then** 系统显示所有已绑定账号的列表，包括账号昵称、绑定时间、当前状态（有效/过期）
2. **Given** 用户正在查看已绑定账号列表，**When** 用户点击某个账号旁边的"解绑"按钮，**Then** 系统弹出确认对话框，用户确认后移除该账号绑定，并更新列表
3. **Given** 某个已绑定账号的Cookie或授权已过期，**When** 系统检测到该账号状态为"过期"，**Then** 在账号列表中显示"过期"标签，并提供"重新绑定"操作入口

---

### Edge Cases

- 当用户在Cookie绑定过程中输入格式错误的字符串（非Cookie格式）时，系统如何提示？
- 当扫码过程中用户取消授权（在App端点击"取消"）时，系统如何检测并提示？
- 当用户同时打开多个绑定对话框并尝试绑定相同账号时，系统如何处理并发冲突？
- 当B站登录API服务不可用时，扫码功能如何降级或提示用户使用Cookie方式？
- 当用户绑定账号后，该账号在B站端修改了密码或登出所有设备时，系统如何检测并更新绑定状态？
- 当系统存储的Cookie或授权凭证需要加密保存时，如何确保敏感数据安全？
- 当用户尝试绑定已被其他用户绑定的B站账号时，系统是否允许（单账号多用户场景）？

## Requirements *(mandatory)*

### Functional Requirements

#### 前端界面需求

- **FR-001**: 系统必须提供"绑定B站账号"对话框，包含"Cookie绑定"和"扫码登录"两个标签页切换
- **FR-002**: Cookie绑定标签页必须包含一个多行文本输入框，用于用户粘贴Cookie字符串
- **FR-003**: 扫码登录标签页必须显示二维码图片，二维码下方显示当前扫码状态文本提示
- **FR-004**: 扫码登录标签页必须提供"重新获取二维码"按钮，在二维码过期时可见
- **FR-005**: 对话框必须提供"取消"和"保存"两个操作按钮，保存按钮在Cookie绑定模式下可用
- **FR-006**: 系统必须在绑定成功后显示成功消息提示，并自动关闭对话框
- **FR-007**: 系统必须在绑定失败时显示具体错误原因（Cookie无效、API调用失败、网络超时等）

#### API接口需求

- **FR-008**: 系统必须提供POST `/api/v1/bilibili/bind/cookie` 接口，接受Cookie字符串作为请求体，返回绑定结果
- **FR-009**: 系统必须提供POST `/api/v1/bilibili/bind/qrcode/generate` 接口，生成二维码登录URL和唯一的qrcode_key
- **FR-010**: 系统必须提供GET `/api/v1/bilibili/bind/qrcode/poll?qrcode_key={key}` 接口，返回当前扫码状态（pending/scanned/confirmed/expired）
- **FR-011**: Cookie绑定接口必须验证Cookie的有效性，通过调用B站用户信息API确认Cookie可用
- **FR-012**: 二维码生成接口必须调用B站登录API获取登录二维码和轮询密钥
- **FR-013**: 二维码轮询接口必须每次请求调用B站API检查最新状态，并在状态为"已确认"时获取授权凭证

#### 后端数据处理需求

- **FR-014**: 系统必须将绑定的B站账号信息存储到数据库，包括账号ID、昵称、绑定时间、凭证类型（cookie/oauth）
- **FR-015**: 系统必须加密存储敏感凭证数据（Cookie或OAuth token），使用配置的ENCRYPT_KEY进行加密
- **FR-016**: 系统必须检测重复绑定，当同一B站账号ID已存在时，返回提示信息而不是覆盖
- **FR-017**: 系统必须在绑定成功后将账号ID与当前登录用户关联，支持一个用户绑定多个B站账号
- **FR-018**: 系统必须定期验证已绑定账号的凭证有效性，将过期账号标记为"需要重新绑定"状态

#### 扫码轮询需求

- **FR-019**: 前端必须在扫码模式下每2秒调用一次轮询接口，检查扫码状态变化
- **FR-020**: 前端必须在检测到"已扫码"状态时更新界面提示文本为"等待确认"
- **FR-021**: 前端必须在检测到"已确认"状态时停止轮询，显示成功消息并关闭对话框
- **FR-022**: 前端必须在检测到"已过期"状态时停止轮询，显示"二维码已过期"并启用"重新获取二维码"按钮
- **FR-023**: 前端必须在用户关闭对话框或切换到Cookie标签页时停止轮询，避免不必要的API调用

### Key Entities

- **BilibiliAccount**: 代表一个已绑定的B站账号
  - 账号ID（B站UID）
  - 账号昵称
  - 绑定时间
  - 绑定用户ID（关联到系统用户）
  - 凭证类型（cookie/oauth）
  - 加密后的凭证数据
  - 账号状态（active/expired/invalid）
  - 最后验证时间

- **QRCodeSession**: 代表一次扫码登录会话
  - 会话唯一标识（qrcode_key）
  - 二维码图片URL
  - 创建时间
  - 过期时间（默认2分钟）
  - 当前状态（pending/scanned/confirmed/expired）
  - 关联用户ID（创建该会话的用户）

> **Constitution Alignment Hint**  
> 本功能需求遵循以下顺序：  
> 1. **前端界面**：用户在"绑定B站账号"对话框中选择Cookie或扫码方式，输入凭证或扫描二维码；  
> 2. **API 合约**：前端调用 `/api/v1/bilibili/bind/cookie` 或 `/api/v1/bilibili/bind/qrcode/*` 接口，传递绑定参数，接收绑定结果（成功/失败、错误信息）；  
> 3. **后端实现**：基于 Bun 运行时，接口验证凭证有效性，调用B站API，加密存储到SQLite数据库，关联用户账号。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在30秒内通过Cookie方式完成B站账号绑定（从打开对话框到绑定成功）
- **SC-002**: 用户可以在1分钟内通过扫码方式完成B站账号绑定（从生成二维码到扫码确认）
- **SC-003**: 系统在用户提交Cookie后的3秒内返回验证结果（有效/无效）
- **SC-004**: 二维码轮询接口的响应时间在95%的情况下低于500毫秒
- **SC-005**: 用户在首次尝试时完成绑定的成功率达到90%以上（排除用户提供无效凭证的情况）
- **SC-006**: 系统能够检测并阻止100%的重复绑定尝试，并向用户提供清晰的提示信息
- **SC-007**: 已绑定账号的凭证有效性检查准确率达到100%（能正确识别过期和无效凭证）

## Assumptions

1. **B站API可用性**: 假设B站提供稳定的用户信息API和登录API，用于验证Cookie和生成扫码登录二维码
2. **Cookie格式**: 假设用户提供的Cookie是完整的HTTP Cookie字符串（key=value格式），包含必要的认证字段（如SESSDATA）
3. **加密密钥配置**: 假设系统已正确配置 `ENCRYPT_KEY` 环境变量，用于加密存储敏感凭证
4. **单用户多账号**: 假设系统允许一个用户绑定多个B站账号，用于监控不同账号的视频数据
5. **二维码有效期**: 假设B站二维码的有效期为2分钟（120秒），轮询间隔为2秒
6. **前端状态管理**: 假设前端使用React状态管理轮询定时器，在组件卸载时正确清理定时器
7. **错误提示语言**: 假设所有用户界面和错误提示使用中文

## Dependencies

- **外部依赖**: B站登录API和用户信息API必须可访问
- **内部依赖**: 
  - 用户认证系统（JWT）必须已实现，确保只有登录用户可以绑定账号
  - 数据库加密工具函数（encrypt/decrypt）必须已实现
  - 数据库 `bilibili_accounts` 表必须已创建
- **配置依赖**: `ENCRYPT_KEY` 环境变量必须在生产和开发环境中正确配置

## Out of Scope

- 不包括OAuth2.0完整流程的实现（仅限B站现有的扫码登录机制）
- 不包括账号绑定后的自动数据同步功能（该功能属于视频监控任务的一部分）
- 不包括多租户权限管理（假设在单用户或单团队场景下使用）
- 不包括绑定历史记录和审计日志功能
- 不包括批量导入多个账号的功能
